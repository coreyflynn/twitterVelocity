<!DOCTYPE html><html lang="en"><head><title>barista</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="barista"><meta name="groc-project-path" content="source/barista.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">source/barista.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><pre><code>Barista.js 0.2.0
(c) 2013 Corey Flynn, Broad Institute.
For all documentation:
http://cmap.github.io/barista
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initial-setup">Initial Setup</h3>

<p>build the top level namespace.  All Barista components will be exposed through this object</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">Barista</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>current version of the library</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.2.0&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build objects to be extended for Models, Collections, and Views</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build an array to contain backing datasets definitions</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cellhistologydataset"><strong>CellHistologyDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
Cellular Contexts available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>CellHistologyDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">CellHistology</span><span class="o">:</span>
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;CellHistology&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]},&quot;cell_histology&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;cell_id&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>

        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its cell_histology and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">cell_histology</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">cell_histology</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Cell Histology&#39;</span><span class="p">,</span>
              <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;cell_histology&#39;</span><span class="p">,</span>
              <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#BB4D8A&#39;</span><span class="p">,</span>
            <span class="p">});</span>
            <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="celliddataset"><strong>CellIDDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
Cellular Contexts available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>CellIDDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">CellID</span><span class="o">:</span>
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 4 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;CellID&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]},&quot;cell_id&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;cell_id&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its cell_id and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">cell_id</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Cell ID&#39;</span><span class="p">,</span>
              <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">,</span>
              <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#CC79A7&#39;</span><span class="p">,</span>
            <span class="p">});</span>
            <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="celllineagedataset"><strong>CellLineageDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
Cellular Contexts available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>CellLineageDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">CellLineage</span><span class="o">:</span> 
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;CellLineage&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]},&quot;cell_lineage&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;cell_id&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its cell_lineage and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">cell_lineage</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">cell_lineage</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Cell Lineage&#39;</span><span class="p">,</span>
              <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;cell_lineage&#39;</span><span class="p">,</span>
              <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#DDA6C4&#39;</span><span class="p">,</span>
            <span class="p">});</span>
            <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cellmutationdataset"><strong>CellMutationDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
Cellular mutation annotations available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>CellMutationDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">CellMutation</span><span class="o">:</span> 
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;CellMutation&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;d=mutations&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>filter the list based on the query.  self comes from the closure in the view that calls the
dataset. It shold be a reference to the view that is consuming the dataset.  That view should
have a typeahead elment in it somewhere</p></div></div><div class="code"><div class="wrapper">          <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.typeahead&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span><span class="s2">&quot;i&quot;</span><span class="p">);</span>
          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">mutation</span><span class="p">){</span><span class="k">return</span> <span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">mutation</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">item</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Cell Mutation&#39;</span><span class="p">,</span>
              <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;mutations&#39;</span><span class="p">,</span>
              <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#999999&#39;</span><span class="p">,</span>
            <span class="p">});</span>
            <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="jobiddataset"><strong>JobIDDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
job IDs available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>JobIDDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">JobID</span><span class="o">:</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">            <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;JobID&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

            <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">                <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/compute_status?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;q={&quot;job_id&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&amp;l=10&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&amp;s={&quot;job_id&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>

                <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

                <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its job_id and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
                        <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">job_id</span><span class="p">);</span>
                        <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
                    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
                            <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
                        <span class="p">}</span>
                        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Job&#39;</span><span class="p">,</span>
                            <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;job_id&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#BDBDBD&#39;</span><span class="p">,</span>
                        <span class="p">});</span>
                        <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
                    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">                    <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="jobstatusdataset"><strong>JobStatusDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
job Statuses available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>JobStatusDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">JobStatus</span><span class="o">:</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">            <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;JobStatus&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

            <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">                <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/compute_status?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;q={&quot;status&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&amp;l=10&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&amp;s={&quot;status&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>

                <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

                <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its status and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
                        <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
                        <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">status</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
                    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
                            <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
                        <span class="p">}</span>
                        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Status&#39;</span><span class="p">,</span>
                            <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#B14A4E&#39;</span><span class="p">,</span>
                        <span class="p">});</span>
                        <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
                    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">                    <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="p100pertinamedataset"><strong>P100PertINameDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
P100 Perturbation IDs available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>P100PertINameDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">P100PertIName</span><span class="o">:</span>
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;P100PertIName&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #7bd9e4&quot;&gt;P100&lt;/span&gt;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://prefix:8080/p100/v1/profileinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;f={&quot;pert_iname&quot;:1}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;pert_iname&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its pert_iname and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add cell lines if required
if (self.match<em>cell</em>lines){
    auto<em>data = auto</em>data.concat(self.cell_lines);  </p></div></div><div class="code"><div class="wrapper">          <span class="c1">// }</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Chemical Reagent&#39;</span><span class="p">,</span>
              <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#E69F00&#39;</span><span class="p">,</span>
            <span class="p">});</span>
            <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of daums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="prismpertinamedataset"><strong>PRISMPertINameDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
PRISM Perturbation IDs available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>PRISMPertINameDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">PRISMPertIName</span><span class="o">:</span>
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;PRISMPertIName&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #8387e6&quot;&gt;PRISM&lt;/span&gt;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/prism/v1/profileinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;f={&quot;pert_iname&quot;:1}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;pert_iname&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its pert_iname and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add cell lines if required
if (self.match<em>cell</em>lines){
    auto<em>data = auto</em>data.concat(self.cell_lines);  </p></div></div><div class="code"><div class="wrapper">          <span class="c1">// }</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Chemical Reagent&#39;</span><span class="p">,</span>
              <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#E69F00&#39;</span><span class="p">,</span>
            <span class="p">});</span>
            <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of daums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertinamedataset"><strong>PertINameDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
Perturbation IDs available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>PertINameDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">PertIName</span><span class="o">:</span>
      <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;PertIName&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}, &quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;f={&quot;pert_iname&quot;:1,&quot;pert_type&quot;:1}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;pert_iname&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">genetic_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;trt_sh&quot;</span><span class="p">,</span><span class="s2">&quot;trt_oe&quot;</span><span class="p">,</span><span class="s2">&quot;trt_sh.cgs&quot;</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its pert_iname and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add cell lines if required
if (self.match<em>cell</em>lines){
    auto<em>data = auto</em>data.concat(self.cell_lines);  </p></div></div><div class="code"><div class="wrapper">          <span class="c1">// }</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">genetic_types</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">pert_type</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Genetic Reagent&#39;</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#0072B2&#39;</span><span class="p">,</span>
              <span class="p">});</span>
              <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">pert_type</span> <span class="o">===</span> <span class="s1">&#39;trt_cp&#39;</span> <span class="p">){</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Chemical Reagent&#39;</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#E69F00&#39;</span><span class="p">,</span>
              <span class="p">});</span>
              <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">pert_type</span> <span class="o">===</span> <span class="s1">&#39;trt_sh.css&#39;</span> <span class="p">){</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Seed Sequence&#39;</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#009E73&#39;</span><span class="p">,</span>
              <span class="p">});</span>
              <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">pert_type</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#999&#39;</span><span class="p">,</span>
              <span class="p">});</span>
              <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of daums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="tooliddataset"><strong>ToolIDDataset</strong></h1>

<p>An object that extends Barista.Datasets to specify a backing dataset for
Tool IDs available in the Connectivity Map</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>ToolIDDataset is typically not used directly, rather it's content
is extracted from Barista.Datasets in views such as CMapSearchView</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">ToolID</span><span class="o">:</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 2 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">            <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;ToolID&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

            <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use cellinfo with custom query params</p></div></div><div class="code"><div class="wrapper">                <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/compute_status?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;q={&quot;tool_id&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&amp;l=10&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&amp;s={&quot;tool_id&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>

                <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

                <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its tool_id and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
                        <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">tool_id</span><span class="p">);</span>
                        <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
                    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
                            <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
                            <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
                        <span class="p">}</span>
                        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Tool&#39;</span><span class="p">,</span>
                            <span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;tool_id&#39;</span><span class="p">,</span>
                            <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#005CF2&#39;</span><span class="p">,</span>
                        <span class="p">});</span>
                        <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
                    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of datums for the autocomplete</p></div></div><div class="code"><div class="wrapper">                    <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cmapperttypealias"><strong>CMapPertTypeAlias</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a utility function to convert standard perturbagen type descriptors into 
more human friendly strings. Given an input type string, an object is 
returned with field names of 'name' and 'acronym'.  If the passed string
is not a recoqnized type, the 'name' and 'acronym' fields are set to the 
passed string</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>var pert_type_object = CMapPertTypeAlias("trt_cp");
pert_type_object.name;
pert_type_object.acronym;
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">CMapPertTypeAlias</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input_type</span><span class="p">){</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">input_type</span><span class="p">){</span>
    <span class="k">case</span> <span class="s2">&quot;trt_cp&quot;</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;small molecule compound&quot;</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="s2">&quot;SMC&quot;</span><span class="p">};</span>
    <span class="k">case</span> <span class="s2">&quot;trt_sh&quot;</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;knock down&quot;</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="s2">&quot;KD&quot;</span><span class="p">};</span>
    <span class="k">case</span> <span class="s2">&quot;trt_oe&quot;</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;over expression&quot;</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="s2">&quot;OE&quot;</span><span class="p">};</span>
    <span class="k">case</span> <span class="s2">&quot;trt_oe.mut&quot;</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;variant&quot;</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="s2">&quot;VAR&quot;</span><span class="p">};</span>
    <span class="k">case</span> <span class="s2">&quot;DOS&quot;</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;tool compounds&quot;</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="s2">&quot;DOS&quot;</span><span class="p">};</span>
    <span class="k">case</span> <span class="s2">&quot;BIOA&quot;</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;drugs and bioactives&quot;</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="s2">&quot;BIOA&quot;</span><span class="p">};</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">input_type</span><span class="p">,</span> <span class="nx">acronym</span><span class="o">:</span> <span class="nx">input_type</span><span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="arrayaverage"><strong>arrayAverage</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a utility function to take the average of an array of numeric values</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>//evaluates to 2
var a = arrayAverage([1,2,3]);
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">arrayAverage</span> <span class="p">(</span><span class="nx">arr</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">num</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">memo</span> <span class="o">+</span> <span class="nx">num</span><span class="p">;</span>
  <span class="p">},</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="getemsizeinpixels"><strong>getEmSizeInPixels</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a utility function to find the size of 1em for the given element id</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">getEmSizeInPixels</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">fontSize</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(\d+)px/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="numberwithcommas"><strong>numberWithCommas</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a utility function to return a number with commas every three digits
credit to Elias Zamaria http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">numberWithCommas</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\B(?=(\d{3})+(?!\d))/g</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="setuserkey"><strong>setUserKey</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a utility function to set a user<em>key attribute on the Barista object and set up
ajax calls to api.lincscloud.org to pass that user</em>key as a parameter</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p>

<ol>
<li>{string}  <strong>key</strong>  The user<em>key to use or a path to a JSON file containing a user</em>key attribute, defaults to <em>""</em></li>
</ol></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">setUserKey</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>configure ajax calls to add the user key parameter on calls to api.lincscloud.org</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxPrefilter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">originalOptions</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">){</span>
    <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;api.lincscloud.org&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">)){</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">originalOptions</span><span class="p">.</span><span class="nx">data</span><span class="p">,{</span><span class="nx">user_key</span><span class="o">:</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">user_key</span><span class="p">}));</span>
    <span class="p">}</span>
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the user<em>key from the url given by string passed in 'key' or set the string itself
as user</em>key if an ajax call to the string fails</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">key_request</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">key</span><span class="p">,{</span><span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span><span class="nx">async</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
  <span class="nx">key_request</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
    <span class="nx">Barista</span><span class="p">.</span><span class="nx">user_key</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">user_key</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">key_request</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">Barista</span><span class="p">.</span><span class="nx">user_key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="barplotmodel"><strong>BarPlotModel</strong></h1>

<p>A Backbone.Model to hold the information needed to make a simple bar plot.  The model includes a title,
axis title, data, data_labels, and an optional object for metadata on the points in the data.  The meta
data object should contain attributes for each meta data category and an array of values matching the size
of the points in the data.  for example:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>meta_data = {'dose: [1,2,3]', timepoint: ['6H','6H','6H']}
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>summly_result = new SummlyResultModel();
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">BarPlotModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>set of model defaults</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>title</strong>  the title of the plot. Defaults to <em>""</em></li>
<li>{String}  <strong>axis<em>title</strong>  the title of the x</em>axis. Defaults to <em>""</em></li>
<li>{Array}  <strong>data</strong>  an array of data for the x_axis. Defaults to <em>[]</em></li>
<li>{Array}  <strong>data<em>labels</strong>  an array of data for the y</em>axis. Defaults to <em>[]</em></li>
<li>{Object}  <strong>meta_data</strong>  object containing meta data for the points in the plot. Defaults to <em>{}</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">axis_title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">data_labels</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">meta_data</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cellcountmodel"><strong>CellCountModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the count of a set of cell_lines.  The data model
captures both the total count of cell lines that meet a search criteria and the count
of each annotation category for the set of cell lines.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>type_string</strong>  the string of pert<em>types that will be search upon fetching data, defaults to *'["trt</em>sh","trt_oe"]'*</li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>cell_count_model = new CellCountModel({type_string: '["trt_sh","trt_oe"]'})</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CellCountModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Number}  <strong>pert_count</strong>  the number of perturbagens matching an api query, defaults to <em>0</em></li>
<li>{Array}  <strong>pert_types</strong>  an array of objects representing pert_type categories to keep track of, defaults to <em>[{}}]</em></li>
<li>{Date}  <strong>last_update</strong>  a timestamp of the latest model update, defaults to the current time</li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">pert_types</span><span class="o">:</span> <span class="p">[{}],</span>
    <span class="nx">g</span><span class="o">:</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
    <span class="nx">last_update</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the cell<em>info api.  the count and pert</em>types data
is replaced with new data coming from the api call</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the pert_params for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">sig_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/siginfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pert_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cell_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">){</span>
      <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
      <span class="nx">pert_params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">,</span> <span class="nx">d</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">pert_params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;},&quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">,</span> <span class="nx">d</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pert_params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">,</span> <span class="nx">f</span><span class="o">:</span><span class="s1">&#39;{&quot;cell_id&quot;:1}&#39;</span><span class="p">,</span> <span class="nx">l</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request to get the total count of cell lines.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">num_perts</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the search type is a "cell", leverage siginfo and cellinfo apis</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">sig_info</span><span class="p">,</span><span class="nx">pert_params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">sig_res</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there is no reponse, set <strong>pert_count: num_perts</strong> and <strong>pert_types: [{}]</strong></p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">sig_res</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
          <span class="nx">num_perts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">num_perts</span><span class="p">,</span> <span class="nx">pert_types</span><span class="o">:</span> <span class="p">[{}],</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there is a reponse, update <em>pert_count</em> and <em>pert_types</em></p></div></div><div class="code"><div class="wrapper">          <span class="nx">num_perts</span> <span class="o">=</span> <span class="nx">sig_res</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">cell_lines</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">sig_res</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">cell_params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="o">:</span><span class="s2">&quot;cell_type&quot;</span><span class="p">};</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">cell_info</span><span class="p">,</span><span class="nx">cell_params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">cell_res</span><span class="p">){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">num_perts</span><span class="p">,</span> <span class="nx">pert_types</span><span class="o">:</span> <span class="nx">cell_res</span><span class="p">,</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the search type is not "cell", leverage the pertinfo api</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pert_info</span><span class="p">,</span><span class="nx">pert_params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">pert_res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pert_res</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there is no reponse, set <strong>pert_count: num_perts</strong> and <strong>pert_types: [{}]</strong></p></div></div><div class="code"><div class="wrapper">          <span class="nx">num_perts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">num_perts</span><span class="p">,</span> <span class="nx">pert_types</span><span class="o">:</span> <span class="p">[{}],</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there is a reponse, update <em>pert_count</em> and <em>pert_types</em></p></div></div><div class="code"><div class="wrapper">          <span class="nx">num_perts</span> <span class="o">=</span> <span class="nx">pert_res</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">cell_lines</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">pert_res</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">cell_params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;cell_id&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="nx">cell_lines</span> <span class="o">+</span> <span class="s1">&#39;}}&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="o">:</span><span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)};</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">cell_info</span><span class="p">,</span><span class="nx">cell_params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">cell_res</span><span class="p">){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">num_perts</span><span class="p">,</span> <span class="nx">pert_types</span><span class="o">:</span> <span class="nx">cell_res</span><span class="p">,</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cellmodel"><strong>CellModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents a cell line
<code>pert_model = new CellModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CellModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>Overides the base Model's initialize method to set the model's cid to the cell_id of the perturbagen</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="compounddetailmodel"><strong>CompoundDetailModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents a single compound's description.  The data
model captures a number of fields including</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>pert_id: the compound's perturbagen identifier</li>
<li>pert_iname: the compound's standardized name</li>
<li>pert_summary: a short description of the compound</li>
<li>pubchem_cid: the PubChem identifier associated with the compound</li>
<li>wiki_url: wikipedia url</li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pert_detail_model = new CompoundDetailModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CompoundDetailModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>short_description</strong>  the short description of a perturbagen (pert_iname), defaults to <em>""</em></li>
<li>{Number}  <strong>long_description</strong>  the long description of a perturbagen (pert_desc), defaults to <em>""</em></li>
<li>{String}  <strong>gene_wiki_link</strong>  the link to a gene's wikipedia link if the perturbagen is a gene, defaults to <em>""</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">pert_id</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">pert_iname</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">pert_summary</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">pubchem_cid</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">wiki_url</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the pert<em>info api. All fields are replaced by the first item
that matches the api search</em>string</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the api parameters to make a regular expression matched query against
pert<em>inames in pertinfo and retrieve the first result's pert</em>iname and pert_desc</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pert_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:&quot;trt_cp&quot;,&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
                          <span class="nx">l</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request.  If the search string is "", set the short and long
description to undefined and trigger a "CompoundDetailModel:ModelIsNull" event.
Otherwise, retrive the pert<em>iname and pert</em>desc of the response and set
them to the model and trigger a "CompoundDetailModel:ModelIsNotNull" event</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pert_info</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">perts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">search_string</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_id</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="nx">pert_iname</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="nx">pert_summary</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                  <span class="nx">pubchem_cid</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                  <span class="nx">wiki_url</span><span class="o">:</span> <span class="kc">null</span><span class="p">})</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;CompoundDetailModel:ModelIsNull&quot;</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the wikipedia link if it is there</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">wiki_url</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_url</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">wiki_re</span> <span class="o">=</span> <span class="sr">/wikipedia/</span>
          <span class="nx">links</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">link</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">wiki_re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">link</span><span class="p">)){</span>
              <span class="nx">wiki_url</span> <span class="o">=</span> <span class="nx">link</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the PubChem ID if it is there.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">pubchem_cid</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pubchem_cid</span><span class="p">){</span>
          <span class="nx">pubchem_cid</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pubchem_cid</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the pert summary if it is there</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">pert_summary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_summary</span><span class="p">){</span>
          <span class="nx">pert_summary</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_summary</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the fields on the model</p></div></div><div class="code"><div class="wrapper">        <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_id</span><span class="o">:</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_id</span><span class="p">,</span>
                  <span class="nx">pert_iname</span><span class="o">:</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_iname</span><span class="p">,</span>
                  <span class="nx">pert_summary</span><span class="o">:</span> <span class="nx">pert_summary</span><span class="p">,</span>
                  <span class="nx">pubchem_cid</span><span class="o">:</span> <span class="nx">pubchem_cid</span><span class="p">,</span>
                  <span class="nx">wiki_url</span><span class="o">:</span> <span class="nx">wiki_url</span><span class="p">,</span>
                  <span class="nx">last_update</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>trigger an event to tell us that the model is not null</p></div></div><div class="code"><div class="wrapper">        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;CompoundDetailModel:ModelIsNotNull&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="genericcountmodel"><strong>GenericCountModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the count of a set CMap databbase items.  The data model
captures the total count of perturbagens that meet a search criteria.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>search<em>field</strong>  the document field the model with count over upon fetching data, defaults to *"pert</em>iname"*</li>
<li>{string}  <strong>url</strong>  the url of the api service to fetch data from, defaults to <em>"http://api.lincscloud.org/a2/pertinfo"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>generic_count_model = new GenericCountModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">GenericCountModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>search<em>field</strong>  the document field the model with count over upon fetching data, defaults to *"pert</em>iname"*</li>
<li>{string}  <strong>url</strong>  the url of the api service to fetch data from, defaults to <em>"http://api.lincscloud.org/a2/pertinfo"</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;search_field&quot;</span><span class="o">:</span> <span class="s2">&quot;pert_iname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.lincscloud.org/a2/pertinfo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;count&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;last_update&quot;</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">(),</span>
    <span class="s2">&quot;search_string&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="initialize">initialize</h2>

<p>custom initialization to make sure we have the correct url for jsonp</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;/?callback=/?&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">))){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;?callback=?&quot;</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the API.  the count is updated with a new 
count based on the results of the api call</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the model's search string attribute</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;search_string&quot;</span><span class="p">,</span><span class="nx">search_string</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up API call parameters</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;search_field&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
              <span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">count</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">),</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">,</span><span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="genericmongomodel"><strong>GenericMongoModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents a generic MongoDB object.  All fields in the document
are passed to the model as normal and a date attribute is set from the _id field of the mongo document
<code>pert_model = new GenericMongoModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">GenericMongoModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>Overides the base Model's initialize method to add the models date attribute and set the cid to the mongo _id field</p></div></div><div class="code"><div class="wrapper">    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cid</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="heatmapmodel"><strong>HeatmapModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the data in a heatmap.  The model contains
a two dimensional array of numbers, row and columns labels, and a title.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>example usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>        heatmap_model = new HeatmapModel();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Array}  <strong>data</strong>  the data object to use in the heatmap. defualts to <em>[[1,2],[3,4]]</em></li>
<li>{Array}  <strong>rid</strong>  the row labels to use in the heatmap. defualts to <em>['1','2']</em></li>
<li>{Array}  <strong>cid</strong>  the column labels to use in the heatmap. defualts to <em>['1','2']</em></li>
<li>{Array}  <strong>annots</strong>  optional annotations categories to show under the heatmap. defualts to <em>undefined</em></li>
<li>{Array}  <strong>annots_label</strong>  optional label for annotations. defualts to <em>undefined</em></li>
<li>{String}  <strong>title</strong>  the title to use in the plot, defaults to <em>""</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    heatmap_model = new HeatmapModel({data: [[1,2],[3,4]],
                                    rid: ['1','2'],
                                    cid: ['1','2'],
                                    annots: ['1','2'],
                                    title: ""});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">HeatmapModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>set up defaults for model values</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Array}  <strong>data</strong>  the data object to use in the heatmap. defualts to <em>[[1,2],[3,4]]</em></li>
<li>{Array}  <strong>rid</strong>  the row labels to use in the heatmap. defualts to <em>['1','2']</em></li>
<li>{Array}  <strong>cid</strong>  the column labels to use in the heatmap. defualts to <em>['1','2']</em></li>
<li>{Array}  <strong>annots</strong>  optional annotations categories to show under the heatmap. defualts to <em>undefined</em></li>
<li>{String}  <strong>title</strong>  the title to use in the plot, defaults to <em>""</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span>
    <span class="nx">rid</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">],</span>
    <span class="nx">cid</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">],</span>
    <span class="nx">annots</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">last_update</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertcellbreakdownmodel"><strong>PertCellBreakdownModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the cell line based breakdown of a set of perturbagens.  The number of
perturbagens matching a query is counted for each cell line. Data for all cell lines that contain a match
to the query are represented in the model</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pert_cell_breakdown_model = new PertCellBreakdownModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertCellBreakdownModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>pert_filter</strong>  the current filter to be used with api calls, defaults to <em>""</em></li>
<li>{Object}  <strong>tree_object</strong>  an object that describes the structured tree data representing cell_line counts, defaults to <em>{children:[]}</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;filter&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tree_object&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">children</span><span class="o">:</span><span class="p">[]}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the pert<em>info api.  the tree</em>object data is updated</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the q param for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pert_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">){</span>
      <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;pert_iname&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;}}&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&quot;}}&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pert_info</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">children</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">children</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">children</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span><span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">_id</span> <span class="o">==</span> <span class="nx">search_string</span><span class="p">;});</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">tree_object</span><span class="o">:</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="nx">children</span><span class="o">:</span><span class="nx">children</span><span class="p">},</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertcountmodel"><strong>PertCountModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the count of a set of perturbagens.  The data model
captures both the total count of perturbagens that meet a search criteria and the count
of each annotation category for the set of perturbagens.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>type<em>string</strong>  the string of pert</em>types that will be search upon fetching data, defaults to <em>'["trt_sh","trt_oe"]'</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>count_model = new PertCountModel({type_string: '["trt_sh","trt_oe"]'})</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertCountModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>type<em>string</strong>  the string of pert</em>types that will be search upon fetching data, defaults to <em>'["trt_sh","trt_oe"]'</em></li>
<li>{Number}  <strong>pert_count</strong>  the number of perturbagens matching an api query, defaults to <em>0</em></li>
<li>{Array}  <strong>pert_types</strong>  an array of objects representing pert_type categories to keep track of, defaults to <em>[{}}]</em></li>
<li>{String}  <strong>pert_type_field</strong>  a field name over which to look for pert<em>types.  This runs an aggregated count over the specified field name in the Connectivity Map database, defaults to *'pert</em>icollection'*</li>
<li>{Date}  <strong>last_update</strong>  a timestamp of the latest model update, defaults to the current time</li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type_string&quot;</span><span class="o">:</span> <span class="s1">&#39;[&quot;trt_cp&quot;]&#39;</span><span class="p">,</span>
    <span class="s2">&quot;count&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;pert_types&quot;</span><span class="o">:</span> <span class="p">[{}],</span>
    <span class="s2">&quot;pert_type_field&quot;</span><span class="o">:</span> <span class="s2">&quot;pert_icollection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_update&quot;</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the pert<em>info api.  the count and pert</em>types data
is replaced with new data coming from the api call</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the q param for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pert_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type_string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_iname&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;}}&#39;</span><span class="p">,</span><span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type_string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span><span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type_string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&quot;,&quot;$options&quot;:&quot;i&quot;},&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">num_perts</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pert_info</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">perts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">num_perts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">num_perts</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">);</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,{</span><span class="nx">g</span><span class="o">:</span><span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_type_field&#39;</span><span class="p">)});</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pert_info</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pert_types</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">num_perts</span><span class="p">,</span> <span class="nx">pert_types</span><span class="o">:</span> <span class="nx">pert_types</span><span class="p">,</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertdetailmodel"><strong>PertDetailModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents a single perturbagen's description.  The data
model captures both the short and long description of a single perturbagen that 
meet a search criteria.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>short_description</strong>  the short description of a perturbagen (pert_iname), defaults to <em>""</em></li>
<li>{Number}  <strong>long_description</strong>  the long description of a perturbagen (pert_desc), defaults to <em>""</em></li>
<li>{String}  <strong>gene_wiki_link</strong>  the link to a gene's wikipedia link if the perturbagen is a gene, defaults to <em>""</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pert_detail_model = new PertDetailModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertDetailModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>short_description</strong>  the short description of a perturbagen (pert_iname), defaults to <em>""</em></li>
<li>{Number}  <strong>long_description</strong>  the long description of a perturbagen (pert_desc), defaults to <em>""</em></li>
<li>{String}  <strong>gene_wiki_link</strong>  the link to a gene's wikipedia link if the perturbagen is a gene, defaults to <em>""</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">short_description</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">long_description</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">gene_wiki_link</span><span class="o">:</span> <span class="s2">&quot;&quot;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the pert<em>info api.  the short</em>description and long_description
are replaced with new data coming from the api call</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the api parameters to make a regular expression matched query against
pert<em>inames in pertinfo and retrieve the first result's pert</em>iname and pert_desc</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pert_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
                          <span class="nx">l</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request.  If the search string is "", set the short and long
description to undefined and trigger a "PertDetailModel:ModelIsNull" event.
Otherwise, retrive the pert<em>iname and pert</em>desc of the response and set
them to the model and trigger a "PertDetailModel:ModelIsNotNull" event</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">short_description</span><span class="p">,</span> <span class="nx">long_description</span><span class="p">,</span> <span class="nx">num_perts</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pert_info</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">perts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">search_string</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">){</span>
        <span class="nx">short_description</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="nx">long_description</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;PertDetailModel:ModelIsNull&quot;</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">short_description</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_iname</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">gene_title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">long_description</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">gene_title</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">gene_wiki_link</span><span class="o">:</span> <span class="s1">&#39;http://en.wikipedia.org/wiki/&#39;</span> <span class="o">+</span> <span class="nx">short_description</span> <span class="o">+</span> <span class="s1">&#39;_(gene)&#39;</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pubchem_cid</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">long_description</span> <span class="o">=</span> <span class="s2">&quot;PubChem ID: &quot;</span> <span class="o">+</span> <span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pubchem_cid</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">gene_wiki_link</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;PertDetailModel:ModelIsNotNull&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">short_description</span><span class="o">:</span> <span class="nx">short_description</span><span class="p">,</span> <span class="nx">long_description</span><span class="o">:</span> <span class="nx">long_description</span><span class="p">,</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertmodel"><strong>PertModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents a single perturbagen
<code>pert_model = new PertModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>Overides the base Model's initialize method to set the model's cid to the pert_id of the perturbagen</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_id&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pert_type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_type&#39;</span><span class="p">);</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">pert_type</span><span class="p">){</span>
      <span class="k">case</span> <span class="s2">&quot;trt_cp&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #E69F00&quot;&gt;SMC&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;trt_oe&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #D55E00&quot;&gt;OE&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;trt_sh&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #56B4E9&quot;&gt;KD&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #BDBDBD&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">pert_type</span> <span class="o">+</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="scatterplotmodel"><strong>ScatterPlotModel</strong></h1>

<p>A Backbone.Model to hold the information needed to make a simple scatter plot.  The model includes a title,
x and y axis titles, x and y data, and an optional object for metadata on the points in the data.  The meta
data object should contain attributes for each meta data category and an array of values matching the size
of the points in the data.  for example:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>meta_data = {'dose: [1,2,3]', timepoint: ['6H','6H','6H']}
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>summly_result = new SummlyResultModel();
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ScatterPlotModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>set of model defaults</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>title</strong>  the title of the plot. Defaults to <em>""</em></li>
<li>{String}  <strong>x<em>axis</em>title</strong>  the title of the x_axis. Defaults to <em>""</em></li>
<li>{String}  <strong>y<em>axis</em>title</strong>  the title of the y_axis. Defaults to <em>""</em></li>
<li>{Array}  <strong>x<em>data</strong>  an array of data for the x</em>axis. Defaults to <em>[]</em></li>
<li>{Array}  <strong>y<em>data</strong>  an array of data for the y</em>axis. Defaults to <em>[]</em></li>
<li>{Object}  <strong>meta_data</strong>  object containing meta data for the points in the plot. Defaults to <em>{}</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">x_axis_title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">y_axis_title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">x_data</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">y_data</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">meta_data</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="sigcountmodel"><strong>SigCountModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the count of a set of signatures.  The data model
captures both the total count of signatures that meet a search criteria and the count
of each annotation category for the set of signatures.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>type<em>string</strong>  the string of pert</em>types that will be search upon fetching data, defaults to <em>'["trt_sh","trt_oe"]'</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>count_model = new SigCountModel({type_string: '["trt_sh","trt_oe"]'})</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SigCountModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>describes the model's default parameters</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>type<em>string</strong>  the string of pert</em>types that will be search upon fetching data, defaults to <em>'["trt_sh","trt_oe"]'</em></li>
<li>{Number}  <strong>sig_count</strong>  the number of perturbagens matching an api query, defaults to <em>0</em></li>
<li>{Array}  <strong>sig_types</strong>  an array of objects representing sig_type categories to keep track of, defaults to <em>[{}}]</em></li>
<li>{String}  <strong>sig_type_field</strong>  a field name over which to look for pert<em>types.  This runs an aggregated count over the specified field name in the Connectivity Map database, defaults to *'pert</em>icollection'*</li>
<li>{Date}  <strong>last_update</strong>  a timestamp of the latest model update, defaults to the current time</li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type_string&quot;</span><span class="o">:</span> <span class="s1">&#39;[&quot;trt_sh&quot;,&quot;trt_oe&quot;,&quot;trt_oe.mut&quot;]&#39;</span><span class="p">,</span>
    <span class="s2">&quot;count&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;pert_types&quot;</span><span class="o">:</span> <span class="p">[{}],</span>
    <span class="s2">&quot;pert_type_field&quot;</span><span class="o">:</span> <span class="s2">&quot;pert_icollection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_update&quot;</span><span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fetch">fetch</h3>

<p>fetches new data from the sig<em>info api.  the count and sig</em>types data
is replaced with new data coming from the api call</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the q param for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">sig_info</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/siginfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type_string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_iname&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;}}&#39;</span><span class="p">,</span><span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type_string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span><span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type_string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&quot;,&quot;$options&quot;:&quot;i&quot;},&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">,</span> <span class="nx">c</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run the api request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">num_perts</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">sig_info</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">perts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">perts</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">num_perts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">num_perts</span> <span class="o">=</span> <span class="nx">perts</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">);</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,{</span><span class="nx">g</span><span class="o">:</span><span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_type_field&#39;</span><span class="p">)});</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">sig_info</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pert_types</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">num_perts</span><span class="p">,</span> <span class="nx">pert_types</span><span class="o">:</span> <span class="nx">pert_types</span><span class="p">,</span> <span class="nx">last_update</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="signaturemodel"><strong>SignatureModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents a single signature
<code>pert_model = new SignatureModel()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SignatureModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>Overides the base Model's initialize method to set the model's cid to the sig_id of the perturbagen</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the unique collection identifier to match the sig_id</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;sig_id&#39;</span><span class="p">);</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>generate an html label for pert_type</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pert_type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_type&#39;</span><span class="p">);</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">pert_type</span><span class="p">){</span>
      <span class="k">case</span> <span class="s2">&quot;trt_cp&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #E69F00&quot;&gt;SMC&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;trt_oe&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #D55E00&quot;&gt;OE&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;trt_sh&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #56B4E9&quot;&gt;KD&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #BDBDBD&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">pert_type</span> <span class="o">+</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">});</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>generate an html label for is_gold</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">is_gold</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;is_gold&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">is_gold</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">is_gold_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #F0E442; color:gray&quot;&gt;Gold&lt;/span&gt;&#39;</span><span class="p">});</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">is_gold_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot;&gt;Not Gold&lt;/span&gt;&#39;</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="summlyresultmodel"><strong>SummlyResultModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the a single CMap Summly result. A single
result is composed of the connection between two pert_inames (a query and a target), 
the component data that went into computing the summly result, and the statistics 
of the summly computation</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>summly_result = new SummlyResultModel();
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SummlyResultModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>set up defaults for model values</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>query</strong>  the query perturbagen (pert_iname), defaults to <em>""</em></li>
<li>{String}  <strong>target</strong>  the target perturbagen (pert_iname), defaults to <em>""</em></li>
<li>{Number}  <strong>summly_score</strong>   summarized connectivity score across cell types, defaults to <em>-666</em></li>
<li>{Number}  <strong>summly_rank</strong>  summarized percent rank across cell types, defaults to <em>-666</em></li>
<li>{Number}  <strong>specificity</strong>  fraction of background queries that score/rank higher than the observed connection, defaults to <em>-666</em></li>
<li>{Object}  <strong>cell<em>line</em>scores</strong>  the connectivity map scores in each cell line for the target perturbagen , defaults to <em>{}</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">query</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">target</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">summly_score</span><span class="o">:</span> <span class="o">-</span><span class="mi">666</span><span class="p">,</span>
    <span class="nx">summly_rank</span><span class="o">:</span> <span class="o">-</span><span class="mi">666</span><span class="p">,</span>
    <span class="nx">specificity</span><span class="o">:</span> <span class="o">-</span><span class="mi">666</span><span class="p">,</span>
    <span class="nx">cell_line_scores</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overides the base model's initialize method to set the model's cid to 
the summly_id</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">options</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pert_type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_type&#39;</span><span class="p">);</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">pert_type</span><span class="p">){</span>
      <span class="k">case</span> <span class="s2">&quot;trt_cp&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #E69F00&quot;&gt;SMC&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;trt_oe&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #D55E00&quot;&gt;OE&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;trt_sh&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: #56B4E9&quot;&gt;KD&lt;/span&gt;&#39;</span><span class="p">});</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">pert_type_label</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">pert_type</span> <span class="o">+</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="tickmodel"><strong>TickModel</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.Model that represents the data required to build a CMapTickView.  The model contains
a data object that has keys for each row to display in the view and array values for each tick
to display in each row. An example data object might look like this:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    {PC3: [.23,-.28], MCF7: [-0.6]}
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>example usage</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    tick_model = new TickModel();
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">TickModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="defaults">defaults</h3>

<p>set up defaults for model values</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>title</strong>  the title to use in the plot, defaults to <em>""</em></li>
<li>{Object}  <strong>data_object</strong>  the data object to use when plotting. defualts to <em>{}</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">data_object</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="analysishistorycollection"><strong>AnalysisHistoryCollection</strong></h1>

<p>A Backbone.Collection that represents a set of analysis history objects.  This collection is suitable for
internal use in GridView.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Backbone.Model}  <strong>model</strong>  the model used for the collection objects. defaults to <em>PertModel</em></li>
<li>{String}  <strong>url</strong>  the url from which model data is fetched. defaults  to <em>'http://api.lincscloud.org/a2/pertinfo?callback=?'</em></li>
<li>{String}  <strong>skip</strong>  the skip parameter used in api calls when the collection is updated. defaults to <em>0</em></li>
<li>{Boolean}  <strong>isLoading</strong>  indicates wether or not the collection is in the middle of a fetch operation. defaults to <em>false</em></li>
</ol></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">AnalysisHistoryCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="model">model</h4>

<p>the model used for the collection objects.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">model</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">GenericMongoModel</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="url">url</h4>

<p>the url from which model data is fetched</p></div></div><div class="code"><div class="wrapper">    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://api.lincscloud.org/compute_status?callback=?&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="skip">skip</h4>

<p>the skip parameter used in api calls when the collection is updated.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">skip</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="isloading">isLoading</h4>

<p>indicates wether or not the collection is in the middle of a fetch operation.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="maxcount">maxCount</h3>

<p>the maximum size of the collection. defaults to Infinity</p></div></div><div class="code"><div class="wrapper">    <span class="nx">maxCount</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="user-id">user_id</h3>

<p>the user_id to search jobs for. Forcing this to be set prevents us from searching other users jobs</p></div></div><div class="code"><div class="wrapper">    <span class="nx">user</span><span class="o">:</span> <span class="s2">&quot;lincs@broadinstitute.org&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getdata">getData</h2>

<p><code>AnalysisHistoryCollection.getData(search_string,search_type,limit)</code></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets additional data from the specified url and stores them as models in the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div><div class="code"><div class="wrapper">    <span class="c1">//</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>search_string</strong>  the string on which a regex search into the api at the collections url will be performed, defaults to <em>""</em></li>
<li>{string}  <strong>search_type</strong>  the type of search that will be performed, defaults to <em>"single"</em></li>
<li>{number}  <strong>limit</strong>  the number of models to be fetched, defaults to <em>30</em></li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="nx">getData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set <strong>isLoading</strong> to true so we don't constantly make api calls before the data comes back</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store the value of <strong>search_string</strong>, <strong>search_type</strong>, and <strong>limit</strong> on the collection object</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_string</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_type</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the query parameter for user_id</p></div></div><div class="code"><div class="wrapper">        <span class="k">switch</span> <span class="p">(</span><span class="nx">search_type</span><span class="p">){</span>
        <span class="k">case</span> <span class="s2">&quot;job_id&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;user_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;job_id&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;status&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;user_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;status&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;tool_id&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;user_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;tool_id&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;user_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;job_id&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a parameter object for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span>
            <span class="nx">sk</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">,</span>
            <span class="nx">s</span><span class="o">:</span> <span class="s1">&#39;{&quot;_id&quot;:-1}&#39;</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the api call and store the results as individual models in the collection.
we don't remove old models in this case as we want to support continuous building
of the model list from a remote api.  On success, set <strong>isLoading</strong> back to false</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">res</span><span class="p">,{</span><span class="nx">remove</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a second api call to find the maximum number of items in the collection
and set that as an attribute on it</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">==</span> <span class="kc">Infinity</span><span class="p">){</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">,[</span><span class="s1">&#39;l&#39;</span><span class="p">,</span><span class="s1">&#39;sk&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">]);</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,{</span><span class="nx">c</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cellcollection"><strong>CellCollection</strong></h1>

<p>A Backbone.Collection that represents a set of cell types.  This collection is suitable for 
internal use in GridView.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Backbone.Model}  <strong>model</strong>  the model used for the collection objects. defaults to <em>PertModel</em></li>
<li>{String}  <strong>url</strong>  the url from which model data is fetched. defaults  to <em>'http://api.lincscloud.org/a2/pertinfo?callback=?'</em></li>
<li>{String}  <strong>skip</strong>  the skip parameter used in api calls when the collection is updated. defaults to <em>0</em></li>
<li>{Boolean}  <strong>isLoading</strong>  indicates wether or not the collection is in the middle of a fetch operation. defaults to <em>false</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pert_collection = new CellCollection({model: PertModel,
url: 'http://api.lincscloud.org/a2/pertinfo?callback=?',
skip: 0,
isLoading: false});</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">CellCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="model">model</h4>

<p>the model used for the collection objects. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">model</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CellModel</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="url">url</h4>

<p>the url from which model data is fetched</p></div></div><div class="code"><div class="wrapper">    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?callback=?&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="skip">skip</h4>

<p>the skip parameter used in api calls when the collection is updated. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">skip</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="isloading">isLoading</h4>

<p>indicates wether or not the collection is in the middle of a fetch operation. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getdata">getData</h2>

<p><code>PertCollection.getData(search_string,search_type,limit)</code></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets additional data from the specified url and stores them as models in the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p>

<ol>
<li>{string}  <strong>search_string</strong>  the string on which a regex search into the api at the collections url will be performed, defaults to <em>""</em></li>
<li>{string}  <strong>search_column</strong>  the column to query the search<em>string against, defaults to "cell</em>id"</li>
<li>{string}  <strong>search_type</strong>  the type of search that will be performed, defaults to <em>"single"</em></li>
<li>{number}  <strong>limit</strong>  the number of models to be fetched, defaults to <em>30</em></li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="nx">getData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_column</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set <strong>isLoading</strong> to true so we don't constantly make api calls before the data comes back</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_string</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search_column</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_column</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_column</span> <span class="o">:</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">;</span>
        <span class="c1">//TODO big hack to adapt to GridView implementation</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">search_column</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">search_column</span> <span class="o">=</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>this.search<em>type = (search</em>type !== undefined) ? search_type : '';</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">search_column</span> <span class="o">==</span> <span class="s1">&#39;mutations&#39;</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]},&quot;mutations&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]},&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_column</span> <span class="o">+</span> <span class="s1">&#39;&quot;:&#39;</span> <span class="o">+</span> <span class="s1">&#39;{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a parameter object for the api call
TODO-remove: alert(this.q_param);</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>s: this.s_param, // no sorting yet</p></div></div><div class="code"><div class="wrapper">            <span class="nx">sk</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">};</span>
        
        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">res</span><span class="p">,{</span><span class="nx">remove</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;fetch&quot;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="genericjsoncollection"><strong>GenericJSONCollection</strong></h1>

<p>A Backbone.Collection that represents and arbitrary set of objects stored
in a JSON file. The JSON file is assumed to contain a top level array
containing objects.  Each object in the array is modeled as a base
Backbone.Model inside of the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Backbone.Model}  <strong>model</strong>  the model used for the collection objects. defaults to <em>PertModel</em></li>
<li>{String}  <strong>url</strong>  the url from which model data is fetched. defaults  to <em>'data.json'</em></li>
<li>{String}  <strong>skip</strong>  the skip parameter used in method calls when the collection is updated. defaults to <em>0</em></li>
<li>{Boolean}  <strong>isLoading</strong>  indicates wether or not the collection is in the middle of a fetch operation. defaults to <em>false</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_collection = new PertCollection({model: PertModel,
                                    url: 'http://api.lincscloud.org/a2/pertinfo?callback=?',
                                    skip: 0,
                                    isLoading: false});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">GenericJSONCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>the model used for collection objects</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertModel</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="url">url</h4>

<p>the url from which model data is fetched</p></div></div><div class="code"><div class="wrapper">    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;data.json&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="skip">skip</h4>

<p>the skip parameter used in api calls when the collection is updated. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">skip</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="isloading">isLoading</h4>

<p>indicates wether or not the collection is in the middle of a fetch operation. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="maxcount">maxCount</h3>

<p>the maximum size of the collection. defaults to Infinity</p></div></div><div class="code"><div class="wrapper">    <span class="nx">maxCount</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getdata">getData</h2>

<p><code>GenericJSONCollection.getData(search_string,search_type,limit)</code></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets additional data from the specified url and stores them as models in the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p>

<ol>
<li>{string}  <strong>search_string</strong>  the string on which a regex search into the api at the collections url will be performed, defaults to <em>""</em></li>
<li>{string}  <strong>search_type</strong>  the type of search that will be performed, defaults to <em>"single"</em></li>
<li>{number}  <strong>limit</strong>  the number of models to be fetched, defaults to <em>30</em></li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="nx">getData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set <strong>isLoading</strong> to true so we don't constantly make api calls before the data comes back</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store the value of <strong>search_string</strong>, <strong>search_type</strong>, and <strong>limit</strong> on the collection object</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_string</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_type</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>fetch data from the given url.  If the url attribute is a string, fetch data via an ajax
request. Read each returned item in the response into a new PertModel.  If it is an object, 
assume it is an array of data and read each array item into a new PertModel</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertModel</span><span class="p">(</span><span class="nx">o</span><span class="p">));});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the collection's maxCount attribute to the length of the collection</p></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">PertModel</span><span class="p">(</span><span class="nx">o</span><span class="p">));</span>
                <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the collection's maxCount attribute to the length of the collection</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertcollection"><strong>PertCollection</strong></h1>

<p>A Backbone.Collection that represents a set of perturbagens.  This collection is suitable for 
internal use in GridView.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Backbone.Model}  <strong>model</strong>  the model used for the collection objects. defaults to <em>PertModel</em></li>
<li>{String}  <strong>url</strong>  the url from which model data is fetched. defaults  to <em>'http://api.lincscloud.org/a2/pertinfo?callback=?'</em></li>
<li>{String}  <strong>skip</strong>  the skip parameter used in api calls when the collection is updated. defaults to <em>0</em></li>
<li>{Boolean}  <strong>isLoading</strong>  indicates wether or not the collection is in the middle of a fetch operation. defaults to <em>false</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pert_collection = new PertCollection({model: PertModel,
url: 'http://api.lincscloud.org/a2/pertinfo?callback=?',
skip: 0,
isLoading: false});</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">PertCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="model">model</h4>

<p>the model used for the collection objects. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">model</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertModel</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="url">url</h4>

<p>the url from which model data is fetched</p></div></div><div class="code"><div class="wrapper">    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="skip">skip</h4>

<p>the skip parameter used in api calls when the collection is updated. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">skip</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="isloading">isLoading</h4>

<p>indicates wether or not the collection is in the middle of a fetch operation. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="maxcount">maxCount</h3>

<p>the maximum size of the collection. defaults to Infinity</p></div></div><div class="code"><div class="wrapper">    <span class="nx">maxCount</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getdata">getData</h2>

<p><code>PertCollection.getData(search_string,search_type,limit)</code></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets additional data from the specified url and stores them as models in the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p>

<ol>
<li>{string}  <strong>search_string</strong>  the string on which a regex search into the api at the collections url will be performed, defaults to <em>""</em></li>
<li>{string}  <strong>search_type</strong>  the type of search that will be performed, defaults to <em>"single"</em></li>
<li>{number}  <strong>limit</strong>  the number of models to be fetched, defaults to <em>30</em></li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="nx">getData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set <strong>isLoading</strong> to true so we don't constantly make api calls before the data comes back</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store the value of <strong>search_string</strong>, <strong>search_type</strong>, and <strong>limit</strong> on the collection object</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_string</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_type</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the q param for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;},&quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">){</span>
            <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$in&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;},&quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the sorting paramter for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">s_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_iname&quot;:1}&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a filtering parameter for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">f_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_iname&quot;:1,&quot;pert_type&quot;:1,&quot;pert_id&quot;:1,&quot;num_sig&quot;:1}&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a parameter object for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span>
            <span class="nx">s</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">s_param</span><span class="p">,</span>
            <span class="nx">f</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">f_param</span><span class="p">,</span>
            <span class="nx">sk</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the api call and store the results as individual models in the collection.
we don't remove old models in this case as we want to support continuous building
of the model list from a remote api.  On success, set <strong>isLoading</strong> back to false</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">res</span><span class="p">,{</span><span class="nx">remove</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a second api call to find the maximum number of items in the collection
and set that as an attribute on it</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">==</span> <span class="kc">Infinity</span><span class="p">){</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">,[</span><span class="s1">&#39;l&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;sk&#39;</span><span class="p">]);</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,{</span><span class="nx">c</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="signaturecollection"><strong>SignatureCollection</strong></h1>

<p>A Backbone.Collection that represents a set of signatures.  This collection is suitable for 
internal use in GridView.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Backbone.Model}  <strong>model</strong>  the model used for the collection objects. defaults to <em>PertModel</em></li>
<li>{String}  <strong>url</strong>  the url from which model data is fetched. defaults  to <em>'http://api.lincscloud.org/a2/siginfo?callback=?'</em></li>
<li>{String}  <strong>skip</strong>  the skip parameter used in api calls when the collection is updated. defaults to <em>0</em></li>
<li>{Boolean}  <strong>isLoading</strong>  indicates wether or not the collection is in the middle of a fetch operation. defaults to <em>false</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>pert_collection = new SignatureCollection({model: PertModel,
url: 'http://api.lincscloud.org/a2/siginfo?callback=?',
skip: 0,
isLoading: false});</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">SignatureCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="model">model</h4>

<p>the model used for the collection objects. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">model</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SignatureModel</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="url">url</h4>

<p>the url from which model data is fetched</p></div></div><div class="code"><div class="wrapper">    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://api.lincscloud.org/a2/siginfo?callback=?&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="skip">skip</h4>

<p>the skip parameter used in api calls when the collection is updated. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">skip</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="isloading">isLoading</h4>

<p>indicates wether or not the collection is in the middle of a fetch operation. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="maxcount">maxCount</h3>

<p>the maximum size of the collection. defaults to Infinity</p></div></div><div class="code"><div class="wrapper">    <span class="nx">maxCount</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="gold-only">gold_only</h3>

<p>boolean flag telling the collection to only include gold Connectivity Map signatures</p></div></div><div class="code"><div class="wrapper">    <span class="nx">gold_only</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="getdata">getData</h3>

<p><code>SignatureCollection.getData(search_string,search_type,limit)</code></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets additional data from the specified url and stores them as models in the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p>

<ol>
<li>{string}  <strong>search_string</strong>  the string on which a regex search into the api at the collections url will be performed, defaults to <em>""</em></li>
<li>{string}  <strong>search_type</strong>  the type of search that will be performed, defaults to <em>"single"</em></li>
<li>{number}  <strong>limit</strong>  the number of models to be fetched, defaults to <em>30</em></li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="nx">getData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set <strong>isLoading</strong> to true so we don't constantly make api calls before the data comes back</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store the value of <strong>search_string</strong>, <strong>search_type</strong>, and <strong>limit</strong> on the collection object</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_string</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_type</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the q param for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;&quot;</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gold_only</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;is_gold&quot;:1}&#39;</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">){</span>
            <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gold_only</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_id&quot;:{&quot;$in&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;},&quot;is_gold&quot;:1,&quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_id&quot;:{&quot;$in&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;},&quot;pert_type&quot;:{&quot;$regex&quot;:&quot;^(?!.*c[a-z]s$).*$&quot;}}&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;cell&quot;</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gold_only</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;is_gold&quot;:1}&#39;</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;cell_id&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the sorting paramter for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">s_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_id&quot;:1}&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a filtering parameter for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">f_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_id&quot;:1,&quot;pert_type&quot;:1,&quot;pert_iname&quot;:1,&quot;pert_itime&quot;:1,&quot;pert_idose&quot;:1,&quot;cell_id&quot;:1,&quot;sig_id&quot;:1,&quot;is_gold&quot;:1,&quot;distil_ss&quot;:1,&quot;distil_cc_q75&quot;:1,&quot;ngenes_modulated_dn_lm&quot;:1,&quot;ngenes_modulated_up_lm&quot;:1}&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a parameter object for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span>
            <span class="nx">s</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">s_param</span><span class="p">,</span>
            <span class="nx">f</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">f_param</span><span class="p">,</span>
            <span class="nx">sk</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the api call and store the results as individual models in the collection.
we don't remove old models in this case as we want to support continuous building
of the model list from a remote api.  On success, set <strong>isLoading</strong> back to false</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">getData_promise</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">res</span><span class="p">,{</span><span class="nx">remove</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a second api call to find the maximum number of items in the collection
and set that as an attribute on it</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">==</span> <span class="kc">Infinity</span><span class="p">){</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">,[</span><span class="s1">&#39;l&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;sk&#39;</span><span class="p">]);</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,{</span><span class="nx">c</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the getData_promise for use with downstream functions if we want</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">getData_promise</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="summlyresultcollection"><strong>SummlyResultCollection</strong></h1>

<p>A Backbone.Collection that represents a set of CMap Summly results.  This collection is suitable for 
internal use in GridView.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{Backbone.Model}  <strong>model</strong>  the model used for the collection objects. defaults to <em>SummlyResultModel</em></li>
<li>{String}  <strong>url</strong>  the url from which model data is fetched. defaults  to <em>'http://api.lincscloud.org/a2/summlyinfo?callback=?'</em></li>
<li>{String}  <strong>skip</strong>  the skip parameter used in api calls when the collection is updated. defaults to <em>0</em></li>
<li>{Boolean}  <strong>isLoading</strong>  indicates wether or not the collection is in the middle of a fetch operation. defaults to <em>false</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_collection = new PertCollection({model: PertModel,
                                    url: 'http://api.lincscloud.org/a2/pertinfo?callback=?',
                                    skip: 0,
                                    isLoading: false});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">SummlyResultCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>the model used for collection objects</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SummlyResultModel</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="url">url</h4>

<p>the url from which model data is fetched</p></div></div><div class="code"><div class="wrapper">    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="skip">skip</h4>

<p>the skip parameter used in api calls when the collection is updated. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">skip</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="isloading">isLoading</h4>

<p>indicates wether or not the collection is in the middle of a fetch operation. </p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="maxcount">maxCount</h3>

<p>the maximum size of the collection. defaults to Infinity</p></div></div><div class="code"><div class="wrapper">    <span class="nx">maxCount</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getdatamock">getDataMock</h2>

<pre><code>    PertCollection.getDataMock(limit);
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generates additional fake data objects and stores them as models in the collection</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p>

<ol>
<li>{number}  <strong>limit</strong>  the number of models to be fetched, defaults to <em>30</em></li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="nx">getData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_string</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set <strong>isLoading</strong> to true so we don't constantly make api calls before the data comes back</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store the value of <strong>search_string</strong>, <strong>search_type</strong>, and <strong>limit</strong> on the collection object</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">search_string</span> <span class="o">=</span> <span class="nx">search_string</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="nx">search_type</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on the type of query we are making, set up the q param for the api call.
if we are doing a single query, match that query as a regular expression. If we are
doing a multi query, match exact names. If we are doing a cell line query, only match
cell_ids</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;single&quot;</span> <span class="o">||</span> <span class="nx">search_type</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">===</span> <span class="s2">&quot;multi&quot;</span><span class="p">){</span>
            <span class="nx">search_string</span> <span class="o">=</span> <span class="s1">&#39;[&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&quot;,&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span> <span class="o">=</span> <span class="s1">&#39;{&quot;pert_iname&quot;:{&quot;$in&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="nx">search_string</span> <span class="o">+</span> <span class="s1">&#39;&quot;}}&#39;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a parameter object for the api call</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span>
            <span class="nx">s</span><span class="o">:</span> <span class="s1">&#39;{&quot;num_gold&quot;:1}&#39;</span><span class="p">,</span>
            <span class="nx">sk</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">40000</span> <span class="o">-</span> <span class="mi">30</span><span class="p">))};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the api call and store the results as individual models in the collection.
we don't remove old models in this case as we want to support continuous building
of the model list from a remote api.  On success, set <strong>isLoading</strong> back to false</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">cell_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ASC&quot;</span><span class="p">,</span><span class="s2">&quot;HA1E&quot;</span><span class="p">,</span><span class="s2">&quot;HCC515&quot;</span><span class="p">,</span><span class="s2">&quot;NEU&quot;</span><span class="p">,</span><span class="s2">&quot;NPC&quot;</span><span class="p">,</span><span class="s2">&quot;PHH&quot;</span><span class="p">,</span><span class="s2">&quot;SKL&quot;</span><span class="p">,</span>
              <span class="s2">&quot;MCF7&quot;</span><span class="p">,</span><span class="s2">&quot;HEPG2&quot;</span><span class="p">,</span><span class="s2">&quot;VCAP&quot;</span><span class="p">,</span><span class="s2">&quot;A549&quot;</span><span class="p">,</span><span class="s2">&quot;A375&quot;</span><span class="p">,</span><span class="s2">&quot;HT29&quot;</span><span class="p">,</span><span class="s2">&quot;PC3&quot;</span><span class="p">];</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">random_lines</span> <span class="o">=</span> <span class="nx">cell_lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">14</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">random_line_scores</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">random_lines</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">){</span>
          <span class="nx">random_line_scores</span><span class="p">[</span><span class="nx">line</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="p">});</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">query</span><span class="o">:</span> <span class="nx">search_string</span><span class="p">,</span>
              <span class="nx">target</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">,</span>
              <span class="nx">pert_type</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">pert_type</span><span class="p">,</span>
              <span class="nx">summly_score</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span>
              <span class="nx">summly_rank</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span>
              <span class="nx">specificity</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span>
              <span class="nx">cell_line_scores</span><span class="o">:</span> <span class="nx">random_line_scores</span><span class="p">});</span>
      <span class="p">});</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a second api call to find the maximum number of items in the collection
and set that as an attribute on it</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">&lt;</span> <span class="kc">Infinity</span><span class="p">){</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">,[</span><span class="s1">&#39;l&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;sk&#39;</span><span class="p">]);</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,{</span><span class="nx">c</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="baristabaseview"><strong>BaristaBaseView</strong></h1>

<p>A Backbone.View the serves as the base view for other views in the barista library.  BaristaBaseView provides common
functionality for views including standard initialization, redraw, render, template compilation, and png export functions.
This view by itself will construct a single panel with a png export option, but it is meant to be used as the base view
that more complex views extend</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>base_view = new BaristaBaseView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"col-lg-12"</em></li>
<li>{Number}  <strong>plot_height</strong>  the height of the plot in pixels, defaults to <em>120</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>base_view = new BaristaBaseView({el: $("target_selector",
                            bg_color:"#ffffff", 
                            fg_color: "#1b9e77",
                            span_class: "col-lg-12",
                            plot_height: 120});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>to extend BaristaBaseView, use</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>extended_view = BaristaBaseView.extend({
                                ...
                                });
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaBaseView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>initialize the view.  Views that extend BaristaBaseView should impliment code overiding this method.
If extended BaristaBaseViews want to use the built in base_initialize method of BaristaBaseView, they should
call it in their redraw method.  As an example:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>initialize: function(){
            this.base_initialize();
            //your code here
            }
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="c1">//</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">base_initialize</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;BaristaBaseView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>default model to Backbone.Model.  This default is only provided to make the view
functional as a un-extended standalone.  An appropriate data model should be
supplied for all views that extend BaristaBaseView</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="base-initialize">base_initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view.  This method is provided so it 
can be used in view that extend BaristaBaseView</p></div></div><div class="code"><div class="wrapper">  <span class="nx">base_initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">:</span> <span class="s2">&quot;#1b9e77&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default height for the plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="mi">120</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;col-lg-12&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();}</span> <span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;barista_view&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>completely render the view. Updates both static and dynamic content in the view.  Views
that extend BaristaBaseView should impliment draw code overiding this method.  If extended
BaristaBaseViews want to use the built in base_render method of BaristaBaseView, they should
call it in their render method.  As an example:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>render: function(){
            this.base_render();
            //your code here
            }
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="c1">//</span>

  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="base-render">base_render</h3>

<p>completely redraw the view. Updates both static and dynamic content in the view.
This method is provided so it can be used in view that extend BaristaBaseView</p></div></div><div class="code"><div class="wrapper">  <span class="nx">base_render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check to see if the container is visible, if not, make it visible, but transparent so we draw it with
the proper dimensions</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;:hidden&quot;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.controls_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;controls_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>do any pre save work that the child class may require</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">save_png_pre</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span>
        <span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>do any post save work that the child class may require</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">save_png_post</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="save_png_pre">save<em>png</em>pre</h3>

<p>dummy method that should be overiden if there is any work to do before
saving the png image of the view.  For example, removing elements that
will not render properly could be done before saving the image.  This
function is called as the first step of <em>save_png</em></p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png_pre</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="save_png_post">save<em>png</em>post</h3>

<p>dummy method that should be overiden if there is any work to do after
saving the png image of the view.  For example, restoring elements that
were removed before saving could be done after saving the image.  This
function is called as the last step of <em>save_png</em></p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png_post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="hide">hide</h3>

<p>hides the view by dimming the opacity and hiding it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the hide animation. defualts to <em>1</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.hide(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">hide</span><span class="p">()},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="show">show</h3>

<p>shows the view by brightening the opacity and showing it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the show animation. defualts to <em>1</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.show(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="barplotview"><strong>BarPlotView</strong></h1>

<p>A Backbone.View that displays a scatter plot.  the view's model is assumed to have the same defaults
as specified in <strong>BarPlotModel</strong></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>bar_plot_view = new BarPlotView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{String}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{String}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{String}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
<li>{Array}  <strong>range</strong>  a two element array specifying the plotting bounds of the plot, defaults to <em>[min(data),max(data)]</em></li>
<li>{Bool}  <strong>log</strong>  if set to true, plots the data on a log scale, defaults to <em>false</em></li>
<li>{Number} <strong>min_lock</strong> if set, locks the minimum of the range at the given value. Ignored if range is set. defaults to <em>undefined</em></li>
<li>{Number} <strong>max_lock</strong> if set, locks the maximum of the range at the given value. Ignored if range is set. defaults to <em>undefined</em></li>
<li>{Bool} <strong>min_expand</strong> if set, allows the minimum of the range to expand if data is found below it. defaults to <em>false</em></li>
<li>{Bool} <strong>max_expand</strong> if set, allows the maximum of the range to expand if data is found above it. defaults to <em>false</em></li>
<li>{String} <strong>orientation</strong> sets the orientation of the bar plot. options are 'horizontal' or 'vertical'. defaults to <em>'vertical'</em></li>
<li>{Number}  <strong>plot_height</strong>  the height of the plot in pixels, defaults to <em>120</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>bar_plot_view = new BarPlotView({el: $("target_selector",
                            bg_color:"#ffffff", 
                            fg_color: "#1b9e77",
                            span_class: "span4",
                            scale_by: undefined,
                            range: undefined,
                            log: false,
                            min_lock: undefined,
                            max_lock: undefined,
                            min_expand: false,
                            max_expand: false,
                            plot_height: 120});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BarPlotView</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaBaseView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">BarPlotModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y range and determine if are going to draw the axes dynamically</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">range</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dynamic_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up axis expansion and lock features</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">min_lock</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">min_lock</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">min_lock</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_lock</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_lock</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_lock</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">min_expand</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">min_expand</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">min_expand</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_expand</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_expand</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_expand</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up log flag</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">log</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">log</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the margin</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">margin</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">margin</span> <span class="o">:</span> <span class="mi">50</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the orientation</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">orientation</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">orientation</span> <span class="o">:</span> <span class="s1">&#39;vertical&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_ranges</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scales</span><span class="p">();</span>    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run BaristaBaseView's base_initialize method to handle boilerplate view construction
and initial view rendering</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_initialize</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>completely redraw the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_plot</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-plot">init_plot</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_plot</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_ranges</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scales</span><span class="p">();</span>    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">style_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the bar data</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">orientation</span> <span class="o">===</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render_horizontal_bars</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render_vertical_bars</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;title title&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get model data</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_ranges</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scales</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the bar data</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">orientation</span> <span class="o">===</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">update_horizontal_bars</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">update_vertical_bars</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="set-ranges">set_ranges</h3>

<p>utility function used to get the x and y ranges used in the plot</p></div></div><div class="code"><div class="wrapper">  <span class="nx">set_ranges</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">data</span><span class="p">,</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>calculate the range. If we need to caluclate it dynamically, check the lock and expand
parameters for the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dynamic_range</span> <span class="o">===</span> <span class="kc">true</span><span class="p">){</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the data is of length larger than 1, calculate the range, otherwise set the range to [0,0]</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check the min lock and expand flags and report the min of the range accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">min_lock</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">min_expand</span><span class="p">){</span>
            <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">min</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">min_lock</span> <span class="o">&gt;</span> <span class="nx">data_min</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data_min</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">min_lock</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">min</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">min_lock</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check the max lock and expand flags and report the max of the range accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">max_lock</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">max_expand</span><span class="p">){</span>
            <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">max_lock</span> <span class="o">&lt;</span> <span class="nx">data_max</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data_max</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">max_lock</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">max_lock</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="p">[</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">];</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="set-scales">set_scales</h3>

<p>utility function used to get the x and y scales used in the plot</p></div></div><div class="code"><div class="wrapper">  <span class="nx">set_scales</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="build-axes">build_axes</h3>

<p>utility function used to build x and y axes</p></div></div><div class="code"><div class="wrapper">  <span class="nx">build_axes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">xAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the appropriate axis depending on the orientation of the plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">orientation</span> <span class="o">===</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis x-axis&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">xAxis</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis y-axis&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="s2">&quot;,0)&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">yAxis</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="style-axes">style axes</h3>

<p>utility function to apply custom styles to axis components</p></div></div><div class="code"><div class="wrapper">  <span class="nx">style_axes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;11px&quot;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render_vertical_bars">render<em>vertical</em>bars</h3>

<p>draws bars in vertical mode</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render_vertical_bars</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the model's data</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>figure out how wide each bar will be</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_domain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">.</span><span class="nx">range</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bar_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the data points</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_bar&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_bar&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;data_bar&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bar_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the x axis title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;x_axis_label axis_label&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;axis_title&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the labels if they are there</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">labels</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data_labels&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bar_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bar_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">labels</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;bar_label&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">/</span><span class="mi">2</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;1em&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">style_axes</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render_horizontal_bars">render<em>horizontal</em>bars</h3>

<p>draws bars in horizontal mode</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render_horizontal_bars</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the model's data</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>figure out how tall each bar will be</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">y_domain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">.</span><span class="nx">range</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bar_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the data points</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_bar&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_bar&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;data_bar&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_height</span><span class="o">*</span><span class="nx">i</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bar_height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the x axis title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;x_axis_label axis_label&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;axis_title&#39;</span><span class="p">));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update_vertical_bars">update<em>vertical</em>bars</h3>

<p>updates the data in the bars in vertical orientation</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update_vertical_bars</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>figure out how wide each bar will be</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_domain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">.</span><span class="nx">range</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bar_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot new data points</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">bar_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_bar&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">bar_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;data_bar&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bar_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition points</p></div></div><div class="code"><div class="wrapper">    <span class="nx">bar_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bar_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">)})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove excess points </p></div></div><div class="code"><div class="wrapper">    <span class="nx">bar_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the labels if they are there</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">labels</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data_labels&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">bar_label_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bar_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">labels</span><span class="p">);</span>
      <span class="nx">bar_label_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;bar_label&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">/</span><span class="mi">2</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;1em&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

      <span class="nx">bar_label_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_width</span><span class="o">/</span><span class="mi">2</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;1em&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

      <span class="nx">bar_label_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bar_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition the axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.y-axis&#39;</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">style_axes</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update_horizontal_bars">update<em>horizontal</em>bars</h3>

<p>updates the data in the bars in vertical orientation</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update_horizontal_bars</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>figure out how tall each bar will be</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">y_domain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">.</span><span class="nx">range</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bar_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot new data points</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">bar_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_bar&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">bar_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;data_bar&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bar_height</span><span class="o">*</span><span class="nx">i</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bar_height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition points</p></div></div><div class="code"><div class="wrapper">    <span class="nx">bar_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove excess points </p></div></div><div class="code"><div class="wrapper">    <span class="nx">bar_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition the axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x-axis&#39;</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xAxis</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">style_axes</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="baristacardview"><strong>BaristaCardView</strong></h1>

<p>A Backbone View that displays a card of information wrapped in link.
The view is meant to be a top level entry point to other pages</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>card_view = new BaristaCardView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>url</strong>  the link to navigate to if the card is clicked, defaults to <em>""</em></li>
<li>{string}  <strong>title</strong>  the title of the card. defaults to <em>"title"</em></li>
<li>{string}  <strong>subtitle</strong>  the subtitle of the card. defaults to <em>"subtitle"</em></li>
<li>{string}  <strong>image</strong>  the link to an image to show as the cards main content. defaults to <em>""</em></li>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"col-lg-12"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>card_view = new BaristaCardView({el: $("target_selector",
                            url:"",
                            title:"",
                            subtitle:"",
                            fg_color: "#1b9e77",
                            image:"",
                            span_class: "col-lg-12"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaCardView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;BaristaCardView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="model">model</h2>

<p>supply a base model for the view.  Overide this if you need to use it for dynamic content</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="initialize">initialize</h2>

<p>overide the view's default initialize method in order to catch options and 
render a custom template</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">:</span> <span class="s2">&quot;#1b9e77&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;col-lg-12&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the url</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">&quot;Title&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the subtitle</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">subtitle</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">subtitle</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">subtitle</span> <span class="o">:</span> <span class="s2">&quot;subtitle&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the image</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">image</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">image</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;barista_view&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapCard</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
                        <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                        <span class="nx">subtitle</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">subtitle</span><span class="p">,</span>
                        <span class="nx">image</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">,</span>
                        <span class="nx">fg_color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">}));</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="bubbleview"><strong>BubbleView</strong></h1>

<p>A Backbone.View that displays a single level tree of data as a bubble plot.  The view should be bound to a 
model such as a <strong>PertCellBreakdownModel</strong> that captures tree data in a <em>tree_object</em> attribute. </p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>bubble_view = new BubbleView({el: $("target_selector")});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span4"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>bubble_view = new BubbleView({el: $("target_selector"),
                            fg_color: "#1b9e77",
                            span_class: "span4"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BubbleView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;BubbleView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertCellBreakdownModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">:</span> <span class="s2">&quot;#1b9e77&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;span4&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the plot height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="mi">120</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the bubble minimum and maximum scale values</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">min_val</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">min_val</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">min_val</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_val</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_val</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">max_val</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up splitting categories</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">v_split</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">v_split</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">v_split</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">h_split</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">h_split</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">h_split</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>draw the view from scratch</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">v_center</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">h_center</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the data from the model</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;tree_object&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up some data scaling</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">max_count</span><span class="p">,</span> <span class="nx">min_count</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">max_val</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">max_count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">max_val</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">max_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">min_val</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">min_count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">min_val</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">min_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data_scale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">min_count</span><span class="p">,</span><span class="nx">max_count</span><span class="p">])</span>
            <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">30</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the force directed graph layout</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">force</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">force</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">gravity</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">friction</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">size</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">])</span>
            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">tick</span><span class="p">(</span><span class="nx">e</span><span class="p">);})</span>
            <span class="p">.</span><span class="nx">charge</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;})</span>
            <span class="p">.</span><span class="nx">start</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the initial layout</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">()).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">())</span>
        <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_circle&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;v_category&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">v_split</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">v_split</span><span class="p">];</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">300</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">300</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>specify the nodes selection so we don't have to repeat the selection on each tick</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">drag</span><span class="p">());</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>reset a damening variable for simulation</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">damp</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>tick function for use in the force class</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">tick</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">vertical_split</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">alpha</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;})</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>.attr("r",function(d){return self.data_scale(d.count);});</p></div></div><div class="code"><div class="wrapper">        <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="vertical-split">vertical_split</h3>

<p>push bubbles vertically based on an attribute property</p></div></div><div class="code"><div class="wrapper">  <span class="nx">vertical_split</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">alpha</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">bubble_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">);</span>
    <span class="nx">bubble_selection</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">v_split</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">){</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">v_center</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">damp</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">*</span> <span class="nx">alpha</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">v_center</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">damp</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">*</span> <span class="nx">alpha</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the plot with new data</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the data from the model</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">new_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;tree_object&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the current nodes</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the nodes in this.force</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">new_data</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">new_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">o</span><span class="p">,{</span><span class="nx">x</span><span class="o">:</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="nx">y</span><span class="o">:</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]});</span>
      <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">new_data</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">concat</span><span class="p">(</span><span class="nx">new_data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span><span class="nx">new_data</span><span class="p">.</span><span class="nx">length</span><span class="p">)));</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">new_data</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">new_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">o</span><span class="p">,{</span><span class="nx">x</span><span class="o">:</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="nx">y</span><span class="o">:</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]});</span>
      <span class="p">});</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the initial layout for new bubbles</p></div></div><div class="code"><div class="wrapper">    <span class="nx">bubble_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span><span class="p">());</span>
    <span class="nx">bubble_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_circle&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition bubbles</p></div></div><div class="code"><div class="wrapper">    <span class="nx">bubble_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove bubbles with no data</p></div></div><div class="code"><div class="wrapper">    <span class="nx">bubble_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>start the simulation again</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>specify the nodes selection so we don't have to repeat the selection on each tick</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">force</span><span class="p">.</span><span class="nx">drag</span><span class="p">());</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>tick function for use in the force class</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">tick</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">vertical_split</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">alpha</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;})</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;})</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);});</span>

        <span class="p">}</span>

  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cmapfooterview"><strong>CMapFooterView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A view that provides the standard Connectivity map page footer for apps built on apps.lincscloud.org
the view provides standard copyright text and customizable organization name,
terms and conditions link, and organization logo/link
basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>header = new CMapHeaderView({el:"header_target"});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>organization</strong>  the name of the organization that claims copyright. Defaults to <em>Broad Institute</em></li>
<li>{string}  <strong>terms_url</strong>  The url on which to find terms and conditions. Defaults to <em>http://lincscloud.org/terms-and-conditions/</em></li>
<li>{Array}  <strong>logo</strong>  The urls to organization logos to use. Defaults to <em>['http://coreyflynn.github.io/Bellhop/img/broad_logo_small.png','http://coreyflynn.github.io/Bellhop/img/cmap_logo_small.png']</em></li>
<li>{Array}  <strong>logo_url</strong>  The urls to organization links to use. Defaults to <em>['http://www.broadinstitute.org/','http://lincscloud.org/']</em></li>
<li>{string}  <strong>template</strong>  The path to a handlebars template to use. Defaults to <em>templates/CMapFooter.handlebars</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>header = new CMapFooterView({el:"footer_target", 
                            organization: "Broad Institute",
                            terms_url: "http://lincscloud.org/terms-and-conditions/",
                                logo: ['../img/broad_logo_small.png','../img/cmap_logo_small.png'],
                                logo_url: ['http://www.broadinstitute.org/','http://lincscloud.org/'],
                            template: "../templates/CMapFooter.handlebars"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CMapFooterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;CMapFooterView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize function to compile a built in template and then render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store passed parameters as attributes of the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">organization</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">organization</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">organization</span> <span class="o">:</span> <span class="s2">&quot;Broad Institute&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">terms_url</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">terms_url</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">terms_url</span> <span class="o">:</span> <span class="s2">&quot;http://lincscloud.org/terms-and-conditions/&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logo</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">logo</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">logo</span> <span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://coreyflynn.github.io/Bellhop/img/broad_logo_small.png&#39;</span><span class="p">,</span><span class="s1">&#39;http://coreyflynn.github.io/Bellhop/img/cmap_logo_small.png&#39;</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logo_url</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">logo_url</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">logo_url</span> <span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://www.broadinstitute.org/&#39;</span><span class="p">,</span><span class="s1">&#39;http://lincscloud.org/&#39;</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">:</span> <span class="s2">&quot;templates/CMapFooter.handlebars&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the specified template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapFooter</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>package logos and log_urls into a set of object to iterate over</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">logo_objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">logo</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="nx">logo_objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">logo</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">logo</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">logo_url</span><span class="p">[</span><span class="nx">i</span><span class="p">]});</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span><span class="p">({</span><span class="nx">organization</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">organization</span><span class="p">,</span>
                    <span class="nx">terms_url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">terms_url</span><span class="p">,</span>
                    <span class="nx">logo_objects</span><span class="o">:</span> <span class="nx">logo_objects</span><span class="p">,</span>
                    <span class="nx">year</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()}));</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="cmapheaderview"><strong>CMapHeaderView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A view the provides the standard Connectivity map page header for apps built on apps.lincscloud.org
the header provides links in the view to navigate back to apps.lincscloud.org as well as links for
sharing, settings, and information.  The view accepts as parameters a page title, subtitle, and handlebars template
basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>header = new CMapHeaderView({el:"header_target"});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>title</strong>  The title of the page. Defaults to <em>Title</em></li>
<li>{string}  <strong>subtitle</strong>  The title of the page. Defaults to <em>Sub Title</em></li>
<li>{string}  <strong>template</strong>  The path to a handlebars template to use. Defaults to <em>templates/CMapHeader.handlebars</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>header = new CMapHeaderView({el:"header_target",
                            title: "",
                            subtitle: "",
                            template: "templates/CMapHeader.handlebars"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CMapHeaderView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;CMapHeaderView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize function to compile a built in template and then render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store passed parameters as attributes of the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subtitle</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">subtitle</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">subtitle</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">user</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">user</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the specified template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapHeader</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                    <span class="nx">subtitle</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">subtitle</span><span class="p">,</span>
                    <span class="nx">user</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">}));</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm">A Backbone.View that exposes a custom search bar.  The search bar provides autocomplete</span>
<span class="cm">functionality for Connectivity Map pert\_inames and cell\_ids.  When the user types in the</span>
<span class="cm">search view&#39;s input, a &quot;search:DidType&quot; event is fired.</span>

<span class="cm">@class PertSearchBar</span>
<span class="cm">@constructor</span>
<span class="cm">@extends Backbone.View</span>
<span class="cm">**/</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CellSearchBar</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;CellSearchBar&quot;</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">    determines whether or not the search view will match cell lines for autocomplete</span>

<span class="cm">    @property match_cell_lines</span>
<span class="cm">    @default true</span>
<span class="cm">    @type Boolean</span>
<span class="cm">    **/</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine whether or not we will match cell line strings in the autocomplete</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">match_cell_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">match_cell_lines</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">match_cell_lines</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab cell_ids and store them as an atribute of the view</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">cellinfo</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;cell_id&quot;:{&quot;$regex&quot;:&quot;&quot;}}&#39;</span><span class="p">,</span><span class="nx">d</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">cellinfo</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">cell_lines</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>once the view is rendered, bind a change event to trigger a "search:DidType" event from the view</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">change_callback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span>  <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">cell_lines</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">match_cell_lines</span><span class="p">){</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;cell&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">        Fired when the text in the view&#39;s search box changes</span>

<span class="cm">        @event search:DidType</span>
<span class="cm">        @param {Object} [msg={val:&quot;&quot;,type:&quot;&quot;}] an object containing the message of the event</span>
<span class="cm">        @param {String} [msg.val=&quot;&quot;] the string val of the views search bar at the time of the event</span>
<span class="cm">        @param {String} [msg.type=&quot;&quot;] the type of message being passed, either &quot;&quot; or &quot;cell&quot;. &quot;cell&quot; is passed, if the string matches a cell line and match\_cell\_lines is set</span>
<span class="cm">        **/</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">search_column</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">});</span>
      <span class="p">};</span>

      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;input propertychange change&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span><span class="p">(</span><span class="nx">change_callback</span><span class="p">,</span><span class="mi">500</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind a search:DidType event to the typeahead events coming out of typeahead.js</p></div></div><div class="code"><div class="wrapper">      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.typeahead&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;typeahead:selected typeahead:autocompleted&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">datum</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">search_column</span> <span class="o">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">search_column</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">search_column</span><span class="o">:</span> <span class="nx">search_column</span><span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

  <span class="p">},</span>


  <span class="cm">/**</span>
<span class="cm">    Gets the current text entered in the view&#39;s search bar</span>
<span class="cm">    </span>
<span class="cm">    @method get_val</span>
<span class="cm">    **/</span>
  <span class="nx">get_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">    fills the view&#39;s search bar with a random pert_iname and triggers a &quot;search:DidType&quot; event</span>
<span class="cm">    </span>
<span class="cm">    @method random_val</span>
<span class="cm">    **/</span>
  <span class="nx">random_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cellinfo</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?callback=?&#39;</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">skip</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">40</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;lincs_status&quot;:{&quot;$in&quot;:[&quot;core_cline&quot;,&quot;core_pline&quot;,&quot;DIVR&quot;]}}&#39;</span><span class="p">,</span> <span class="nx">l</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">sk</span><span class="o">:</span><span class="nx">skip</span><span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">cellinfo</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">cell_id</span><span class="p">;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">search_column</span><span class="o">:</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">set_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">new_val</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">new_val</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">new_val</span><span class="p">,</span><span class="nx">search_column</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">});</span> <span class="c1">//TODO need to find search column info</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">    renders the view</span>
<span class="cm">    </span>
<span class="cm">    @method render</span>
<span class="cm">    **/</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>load the template into the view's el tag</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapPertSearchBar</span><span class="p">());</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>hook up the typeahead with backing datasets</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#search&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">).</span><span class="nx">typeahead</span><span class="p">([</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">.</span><span class="nx">CellID</span><span class="p">,</span>
                     <span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">.</span><span class="nx">CellLineage</span><span class="p">,</span>
                     <span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">.</span><span class="nx">CellHistology</span><span class="p">,</span>
                     <span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">.</span><span class="nx">CellMutation</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="compounddetailview"><strong>CompoundDetailView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that shows information about a small molecule compound.  This view is
frequently paired with a CompoundDetailModel.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view = new CompoundDetailView({el: $("target_selector")});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"col-lg-12"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view = new CompoundDetailView({el: $("target_selector"),
                                            model: CompoundDetailModel,
                                            bg_color: "#ffffff",
                                            span_class: "col-lg-12"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CompoundDetailView</span> <span class="o">=</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaBaseView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;CompoundDetailView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CompoundDetailModel</span><span class="p">(),</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the defualt Backbone.View initialize method to bind the view to model changes, bind
window resize events to view re-draws, compile the template, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the plot height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="mi">130</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>initialize the view using the base view's built in method</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_initialize</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>completely render the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the base view components</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static index reagent icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:image&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;index_text_icon&quot;</span><span class="p">)</span>
                      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span> <span class="s2">&quot;http://coreyflynn.github.io/Bellhop/img/CP.png&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static index reagent text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;index_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#E69F00&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;20pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;Small Molecule Compound&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the pert_iname text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.pert_id_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.pert_id_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;pert_id_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;36pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_iname&#39;</span><span class="p">));</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the pert_iname</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.pert_iname_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.pert_iname_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
              <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;pert_iname_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;14pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_id&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the pert<em>summary or clear it if there pert</em>summary is null</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_summary&#39;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render_summary</span><span class="p">({</span><span class="nx">summary_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_summary&#39;</span><span class="p">),</span>
                 <span class="nx">top</span><span class="o">:</span> <span class="mi">36</span><span class="p">,</span>
                 <span class="nx">bottom</span><span class="o">:</span> <span class="mi">136</span><span class="p">,</span>
                 <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pert_iname&#39;</span><span class="p">).</span><span class="nx">length</span><span class="o">*</span><span class="mi">36</span><span class="o">*</span><span class="p">.</span><span class="mi">85</span><span class="p">});</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clear_summary</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check to see if there is a pubchem id and draw a link for it if there
is one</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;pubchem_link&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pubchem_cid&#39;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;pubchem_link&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;pubchem_link no_png_export&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;PubChem&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="s2">&quot;http://pubchem.ncbi.nlm.nih.gov/summary/summary.cgi?cid=&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pubchem_cid&#39;</span><span class="p">)});</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check to see if there is a wikipedia url and draw a link for it if there
is one</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;wiki_link&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;wiki_url&#39;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;wiki_link&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;wiki_link no_png_export&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">80</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;Wiki&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;wiki_url&#39;</span><span class="p">)});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render-summary">render_summary</h3>

<p>utility function to break a long summary string into a multiline
and draw it at the desired location</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>options</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>summary_string</strong>  the string to be displayed, defaults to <em>""</em></li>
<li>{right}  <strong>right</strong>  the x position to place the <strong>right</strong> edge of text, defaults to <em>this.width</em></li>
<li>{left}  <strong>left</strong>  the x position to place the <strong>left</strong> edge of text, defaults to <em>this.width - 500</em></li>
<li>{top}  <strong>top</strong>  the y position to place the <strong>top</strong> edge of text, defaults to <em>0</em></li>
<li>{bottom}  <strong>bottom</strong>  the y position to place the <strong>bottom</strong> edge of text, defaults to <em>100</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">render_summary</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>default arguments if they are not present</p></div></div><div class="code"><div class="wrapper">    <span class="nx">summary_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">summary_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">summary_string</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">top_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">top</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">top</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">bottom_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">:</span> <span class="mi">100</span><span class="p">;</span>
    <span class="nx">right_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">right</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">right</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">left_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">left</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">left</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">500</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>clear existing summary</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">clear_summary</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the number of lines we have room for</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">line_height</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">num_lines_allowed</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">bottom_edge</span> <span class="o">-</span> <span class="nx">top_edge</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">line_height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the number of characters per line we will allow and how
many lines the summary would need if we rendered all of it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">line_width</span> <span class="o">=</span> <span class="nx">right_edge</span> <span class="o">-</span> <span class="nx">left_edge</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">num_char</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">line_width</span> <span class="o">/</span> <span class="mi">13</span> <span class="o">/</span> <span class="p">.</span><span class="mi">75</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">num_lines</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">summary_string</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the line splits to display in the wiki summary</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">num_lines</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">num_lines_allowed</span> <span class="o">-</span> <span class="mi">1</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="p">(</span><span class="nx">summary_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">summary_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">summary_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="nx">summary_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">summary_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw lines</p></div></div><div class="code"><div class="wrapper">    <span class="nx">self</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;summary_text&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;summary_text&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">left_edge</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">top_edge</span> <span class="o">+</span> <span class="mi">13</span> <span class="o">+</span> <span class="nx">i</span><span class="o">*</span><span class="mi">15</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;13pt&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#777777&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>.attr("text-anchor", "middle")</p></div></div><div class="code"><div class="wrapper">        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clear-summary">clear_summary</h3>

<p>utility function to clear the pert summary</p></div></div><div class="code"><div class="wrapper">  <span class="nx">clear_summary</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.summary_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">},</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="save_png_pre">save<em>png</em>pre</h3>

<p>overide the base views save<em>png</em>pre method to clear out the image so we
can render the png properly</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png_pre</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove the static index reagent icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>scoot the inde text to the left</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="save_png_post">save<em>png</em>post</h3>

<p>overide the base views save<em>png</em>post method to restore the image after
saving</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png_post</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static index reagent icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:image&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;index_text_icon&quot;</span><span class="p">)</span>
                      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span> <span class="s2">&quot;http://coreyflynn.github.io/Bellhop/img/CP.png&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>scoot the inde text to the right</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="cm">/**</span>
<span class="cm">A Backbone.View that exposes a custom search bar.  The search bar provides autocomplete</span>
<span class="cm">functionality for Connectivity Map pert\_inames and cell\_ids.  When the user types in the</span>
<span class="cm">search view&#39;s input, a &quot;search:DidType&quot; event is fired.</span>

<span class="cm">@class PertSearchBar</span>
<span class="cm">@constructor</span>
<span class="cm">@extends Backbone.View</span>
<span class="cm">**/</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CompoundSearchBar</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;CompoundSearchBar&quot;</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>once the view is rendered, bind a change event to trigger a "search:DidType" event from the view</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">change_callback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">val</span>  <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="cm">/**</span>
<span class="cm">      Fired when the text in the view&#39;s search box changes</span>

<span class="cm">      @event search:DidType</span>
<span class="cm">      @param {Object} [msg={val:&quot;&quot;,type:&quot;&quot;}] an object containing the message of the event</span>
<span class="cm">      @param {String} [msg.val=&quot;&quot;] the string val of the views search bar at the time of the event</span>
<span class="cm">      @param {String} [msg.type=&quot;&quot;] the type of message being passed, either &quot;&quot; or &quot;cell&quot;. &quot;cell&quot; is passed, if the string matches a cell line and match\_cell\_lines is set</span>
<span class="cm">      **/</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">});</span>
    <span class="p">};</span>

    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;input propertychange change&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span><span class="p">(</span><span class="nx">change_callback</span><span class="p">,</span><span class="mi">500</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind a search:DidType event to the typeahead events coming out of typeahead.js</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.typeahead&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;typeahead:selected typeahead:autocompleted&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">datum</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">});</span>
    <span class="p">});</span>

  <span class="p">},</span>


  <span class="cm">/**</span>
<span class="cm">    Gets the current text entered in the view&#39;s search bar</span>
<span class="cm">    </span>
<span class="cm">    @method get_val</span>
<span class="cm">    **/</span>
  <span class="nx">get_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">    fills the view&#39;s search bar with a random pert_iname and triggers a &quot;search:DidType&quot; event</span>
<span class="cm">    </span>
<span class="cm">    @method random_val</span>
<span class="cm">    **/</span>
  <span class="nx">random_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">skip</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">40000</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pertinfo</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">&#39;{&quot;pert_type&quot;:&quot;trt_cp&quot;}&#39;</span><span class="p">,</span>
          <span class="nx">f</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_iname&quot;:1}&#39;</span><span class="p">,</span>
                    <span class="nx">l</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nx">sk</span><span class="o">:</span><span class="nx">skip</span><span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pertinfo</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_iname</span><span class="p">;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;single&#39;</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">set_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">new_val</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">new_val</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">new_val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;single&#39;</span><span class="p">});</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">    renders the view</span>
<span class="cm">    </span>
<span class="cm">    @method render</span>
<span class="cm">    **/</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>load the template into the view's el tag</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapPertSearchBar</span><span class="p">());</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#search&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">).</span><span class="nx">typeahead</span><span class="p">([{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only return 4 items at a time in the autocomplete dropdown</p></div></div><div class="code"><div class="wrapper">      <span class="nx">limit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>provide a name for the default typeahead data source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Reagents&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the template to render for all results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span class=&quot;label&quot; style=&quot;background-color: {{ color }}&quot;&gt;{{ type }}&lt;/span&gt; {{ value }}&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use twitter's hogan.js to compile the template for the typeahead results</p></div></div><div class="code"><div class="wrapper">      <span class="nx">engine</span><span class="o">:</span> <span class="nx">Hogan</span><span class="p">,</span>

      <span class="nx">remote</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the remote data source to use pertinfo with custom query params</p></div></div><div class="code"><div class="wrapper">        <span class="nx">url</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q={&quot;pert_iname&quot;:{&quot;$regex&quot;:&quot;%QUERY&quot;, &quot;$options&quot;:&quot;i&quot;}, &quot;pert_type&quot;:&quot;trt_cp&quot;}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;f={&quot;pert_iname&quot;:1,&quot;pert_type&quot;:1}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;l=100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&amp;s={&quot;pert_iname&quot;:1}&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>

        <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">datum_list</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">auto_data</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">object_map</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each item, pull out its pert_iname and use that for the
autocomplete value. Build a datum of other relevant data
for use in suggestion displays</p></div></div><div class="code"><div class="wrapper">          <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
            <span class="nx">auto_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">);</span>
            <span class="nx">object_map</span><span class="p">[</span><span class="nx">element</span><span class="p">.</span><span class="nx">pert_iname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we only show unique items</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">auto_data</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a list of datum objects</p></div></div><div class="code"><div class="wrapper">          <span class="nx">auto_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">datum</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
              <span class="nx">tokens</span><span class="o">:</span> <span class="p">[</span><span class="nx">item</span><span class="p">],</span>
              <span class="nx">data</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
            <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">pert_type</span> <span class="o">===</span> <span class="s1">&#39;trt_cp&#39;</span> <span class="p">){</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Chemical Reagent&#39;</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#E69F00&#39;</span><span class="p">,</span>
              <span class="p">});</span>
              <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">datum</span><span class="p">,{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="nx">object_map</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">pert_type</span><span class="p">,</span>
                <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;#999&#39;</span><span class="p">,</span>
              <span class="p">});</span>
              <span class="nx">datum_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datum</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return the processed list of daums for the autocomplete</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">datum_list</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="p">}</span>
    <span class="p">}]);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">FlatTreeMapView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;FlatTreeMapView&quot;</span><span class="p">,</span>

    <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertCellBreakdownModel</span><span class="p">(),</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#d9d9d9&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">well_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">well_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">well_color</span> <span class="o">:</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">:</span> <span class="s2">&quot;#1b9e77&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;span4&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update_vis</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>this.vis<em>overlay = this.top</em>svg.append("g");</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="mi">300</span><span class="p">}));</span>
  <span class="p">},</span>

  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the treemap layout</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">treemap</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">treemap</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">size</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">])</span>
            <span class="p">.</span><span class="nx">sticky</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">count</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the data from the model and plot the state of the treemap</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;tree_object&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there are no cildren in the tree_object, dim the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up an alpha scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">min_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">opacity_map</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
              <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">min_count</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">max_count</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">max_count</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">treemap</span><span class="p">.</span><span class="nx">nodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_cell&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">opacity_map</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dy</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke-width&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">draw_text</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add_tooltips</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">savePng</span><span class="p">();});</span>
  <span class="p">},</span>

  <span class="nx">update_vis</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the data from the model and plot the state of the treemap</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;tree_object&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there are no children in the tree_object, dim the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up an alpha scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">min_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">opacity_map</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">min_count</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">max_count</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">max_count</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span>

    <span class="c1">//add new data if it is there</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">treemap</span><span class="p">.</span><span class="nx">nodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_cell&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">opacity_map</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dy</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;stroke-width&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition elements</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">ease</span><span class="p">(</span><span class="s2">&quot;cubic out&quot;</span><span class="p">).</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">opacity_map</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dy</span><span class="p">;});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>exit old elements</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">treemap</span><span class="p">.</span><span class="nx">nodes</span><span class="p">).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>// add tooltips
this.add_tooltips();</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw_text on the elements that have room for it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">clear_text</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> <span class="nx">self</span><span class="p">.</span><span class="nx">draw_text</span><span class="p">();</span> <span class="nx">self</span><span class="p">.</span><span class="nx">add_tooltips</span><span class="p">();},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">add_tooltips</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a selection of all cells in the treemap</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">cell_selection</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;_cell&#39;</span><span class="p">);</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove existing tooltips so we don confuse the labels</p></div></div><div class="code"><div class="wrapper">    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add new tooltips if there is more than just the base cell in
in the treemap (i.e. it is a non-empty dataset)</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">cell_selection</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
      <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">({</span>
          <span class="nx">placement</span><span class="o">:</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span>
          <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>
          <span class="nx">trigger</span><span class="o">:</span> <span class="s1">&#39;hover focus&#39;</span><span class="p">,</span>
          <span class="nx">title</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">clear_text</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.name&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.count&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">draw_text</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.name&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.name&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">treemap</span><span class="p">.</span><span class="nx">nodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">dy</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">){</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dy</span><span class="o">/</span><span class="mi">2</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;12pt&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.count&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">]).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.count&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">treemap</span><span class="p">.</span><span class="nx">nodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">dy</span> <span class="o">&lt;</span> <span class="mi">40</span> <span class="o">||</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">){</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">numberWithCommas</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">dy</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;12pt&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">savePng</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">top_svg</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;cmapTreeMap&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span><span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);})};</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">GridView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;GridView&quot;</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>default search value</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">search_val</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up grid options</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;col_lg_12&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">legend</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">legend</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">legend</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">no_download</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_download</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_download</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">no_slice</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_slice</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_slice</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">no_legend</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_legend</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">no_legend</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span> <span class="o">:</span> <span class="mi">30</span><span class="p">;</span>

    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a default collection and column definition for the grid to operate on</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">PertCollection</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">columns</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">columns</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">columns</span> <span class="o">:</span> <span class="p">[{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;pert_iname&quot;</span><span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;Reagent Name&quot;</span><span class="p">,</span> <span class="nx">cell</span><span class="o">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nx">editable</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span>
                                            <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;pert_type_label&quot;</span><span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;Pert Type&quot;</span><span class="p">,</span> <span class="nx">cell</span><span class="o">:</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">HTMLCell</span><span class="p">,</span> <span class="nx">editable</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span>
                                            <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;num_inst&quot;</span><span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;Experiments&quot;</span><span class="p">,</span> <span class="nx">cell</span><span class="o">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">editable</span><span class="o">:</span> <span class="kc">false</span><span class="p">}];</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build the template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build the grid on the template using a clickable row.  If a row is clicked, a grid:RowClick event
is fired with the row's model as the passed data.
build the clickable row</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">ClickableRow</span> <span class="o">=</span> <span class="nx">Backgrid</span><span class="p">.</span><span class="nx">Row</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;click&quot;</span><span class="o">:</span> <span class="s2">&quot;onClick&quot;</span>
      <span class="p">},</span>
      <span class="nx">onClick</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;grid:RowClick&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.cmap-active-grid-row&quot;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;cmap-active-grid-row&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;cmap-active-grid-row&quot;</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>replicate Backgrid.Row's native render method</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">fragment</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cells</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cells</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fragment</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">delegateEvents</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the row's model is active, highlight it</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;active_row&#39;</span><span class="p">)){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;cmap-active-grid-row&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build the grid</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backgrid</span><span class="p">.</span><span class="nx">Grid</span><span class="p">({</span>
      <span class="nx">row</span><span class="o">:</span> <span class="nx">ClickableRow</span><span class="p">,</span>
      <span class="nx">columns</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">columns</span><span class="p">,</span>
      <span class="nx">collection</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">$el</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a button to scroll to the top of the grid once it is scroll down</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">add_scroll_to_top_button</span><span class="p">();</span>

    <span class="c1">//bind the table to a function to check for scroll boundaries</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">scroll</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">checkscroll</span><span class="p">();});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind the download text to a function to download the data in the table</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_download&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">download_table</span><span class="p">();});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind the download text to a function to slice the data in the table out of the
Connectivity Map database.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;slice&quot;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">checkscroll</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">debounce</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">show_scroll_to_top_button</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hide_scroll_to_top_button</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">triggerPoint</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">+</span> <span class="nx">triggerPoint</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">scrollHeight</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">skip</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">update_collection</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">search_val</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">search_type</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span><span class="mi">100</span><span class="p">),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="add_scroll_to_top_button">add<em>scroll</em>to<em>top</em>button</h3>

<p>adds a UI control to scroll the top of the grid</p></div></div><div class="code"><div class="wrapper">  <span class="nx">add_scroll_to_top_button</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;scroll_button&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;button id=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span> <span class="o">+</span> <span class="s1">&#39;&quot; class=&quot;cmap_grid_to_top_button&quot;&gt;Scroll to Top&lt;/button&gt;&#39;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">scroll_to_top</span><span class="p">();});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hide_scroll_to_top_button</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="scroll_to_top">scroll<em>to</em>top</h3>

<p>scrolls the grid to the top of its container
argurments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the duration of the scroll animation in ms, defaults to <em>500</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">scroll_to_top</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">500</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">scrollTop</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hide_scroll_to_top_button</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="show_scroll_to_top_button">show<em>scroll</em>to<em>top</em>button</h3>

<p>shows the scroll to top button
argurments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the duration of the scroll animation in ms, defaults to <em>500</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">show_scroll_to_top_button</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">500</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span><span class="p">).</span><span class="nx">clearQueue</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="hide_scroll_to_top_button">hide<em>scroll</em>to<em>top</em>button</h3>

<p>hides the scroll to top button
argurments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the duration of the scroll animation in ms, defaults to <em>500</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">hide_scroll_to_top_button</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span><span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">500</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span><span class="p">).</span><span class="nx">clearQueue</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scroll_to_top_button_id</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">replace_collection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_val</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">getData_promise</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">search_val</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_val</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_val</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_val</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_type</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
    <span class="nx">getData_promise</span> <span class="o">=</span>  <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">search_val</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">search_type</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">listenToOnce</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;grid:ReplaceCollection&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;grid:Add&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">resize_div</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>reset the slice all data button and reject the slice
deferred if it is present</p></div></div><div class="code"><div class="wrapper">      <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;slice&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">getData_promise</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">update_collection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">search_val</span><span class="p">,</span><span class="nx">search_type</span><span class="p">,</span><span class="nx">limit</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">getData_promise</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">maxCount</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">search_val</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_val</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_val</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_val</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">search_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">search_type</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">search_type</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">limit</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">limit</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
      <span class="nx">getData_promise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">search_val</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">search_type</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">resize_div</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenToOnce</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;grid:UpdateCollection&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;grid:Add&quot;</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">getData_promise</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">clear_collection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">maxCount</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>reset the slice all data button and reject the slice
deferred if it is present</p></div></div><div class="code"><div class="wrapper">      <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;slice&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">resize_div</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">container_height</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">height</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">data_height</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">+</span> <span class="mi">40</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">target_height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data_height</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">)</span> <span class="o">?</span> <span class="mi">300</span> <span class="o">:</span> <span class="nx">data_height</span><span class="p">;</span>

      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">stop</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">height</span><span class="o">:</span><span class="nx">target_height</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
    <span class="p">},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;backgrid_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapBaseGrid</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                             <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                             <span class="nx">legend</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">legend</span><span class="p">,</span>
                             <span class="nx">no_download</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">no_download</span><span class="p">,</span>
                             <span class="nx">no_slice</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">no_slice</span><span class="p">,</span>
                             <span class="nx">no_legend</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">no_legend</span><span class="p">,</span>
                          <span class="p">}));</span>
  <span class="p">},</span>

  <span class="nx">slice_all_table_data</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>change the button state to progress</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>create a Deferred on the object to handle interaction with the slicing
operation.  This allows us to resolve the Deffered later in another
method before the ajax call returns if we need to</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">slice_defer</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the Deferred resolves successfully, leave the button alone and let other the ajax call
below manipulate it.  If it is rejected, set the button back up to its original state.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;slice&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">);</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the API 'q' query parameter from the grid's collection and send it
to sig<em>slice API.  if the slice job completes, check the return for a 
file</em>url attribute and change the link in the slice button to expose the
link.  If it does not exist, the slice failed and we display a failure
message asking the user to try again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">sig_slice</span> <span class="o">=</span> <span class="s1">&#39;http://prefix:8080/a2/sigslice?callback=?&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">sig_slice</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span><span class="nx">l</span><span class="o">:</span> <span class="mi">1000</span><span class="p">},</span>
      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">file_url</span><span class="p">){</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">file_url</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if 60s pass, we assume that is too long and we 
update the button with an error message and 
resolve the deferred to indicate we finished the 
ajax call normally.  This is a hack to emulate a 404 error in jsonp</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">slice_timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">change_slice_button_state</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">);</span>
    <span class="p">},</span><span class="mi">60000</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">change_slice_button_state</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="nx">link</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>unbind an handlers on the button</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">unbind</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle the re-binding of handlers and update the button text and icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">switch</span> <span class="p">(</span><span class="nx">state</span><span class="p">){</span>
      <span class="k">case</span> <span class="s2">&quot;slice&quot;</span><span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the slice button to show an available data slice</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;font color=&quot;#0072B2&quot;&gt;&lt;i class=&quot;icon-cogs&quot;&gt;&lt;/i&gt; slice all data&lt;/font&gt;&#39;</span><span class="p">);</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rebind the click event and clear a timeout if present</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_all_table_data</span><span class="p">();});</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_timeout</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s2">&quot;progress&quot;</span><span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>indicate that we are making a data slice</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;font color=&quot;#0072B2&quot;&gt;&lt;i class=&quot;icon-cog icon-spin&quot;&gt;&lt;/i&gt; slicing&lt;/font&gt;&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>unbind all handlers so that we can't click the while while we are slicing</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">unbind</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s2">&quot;link&quot;</span><span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>construct an html string to expose the link</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">html_string</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;a href=&quot;&#39;</span><span class="p">,</span>
                   <span class="nx">link</span><span class="p">,</span>
                   <span class="s1">&#39;&quot; class=&quot;cmap-link&quot;&gt;&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;&lt;font color=&quot;#0072B2&quot;&gt;&lt;i class=&quot;icon-download&quot;&gt;&lt;/i&gt; download slice&lt;/font&gt;&lt;/a&gt;&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the button and resolve the deferred to 
indicate we finished the ajax call normally</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">html_string</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_timeout</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s2">&quot;fail&quot;</span><span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update the button with an error message,
resolve the deferred and clear the Timeout</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;font color=&quot;#D55E00&quot;&gt;&lt;i class=&quot;icon-exclamation&quot;&gt;&lt;/i&gt; slice failed. try again?&lt;/font&gt;&#39;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_slice&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_all_table_data</span><span class="p">();});</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">slice_defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">slice_timeout</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">},</span>

  <span class="nx">download_table</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>indicate we are downloading something</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_download&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;font color=&quot;#0072B2&quot;&gt;&lt;i class=&quot;icon-refresh icon-spin&quot;&gt;&lt;/i&gt; exporting&lt;/font&gt;&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up api call parameters</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">q_param</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nx">s</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">s_param</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab column header names</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">columns</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab column data names</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">columns</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a JSON API call to grab data for the table</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nx">headers</span><span class="p">];</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">line_data</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each data name in the table, grab the data. translate html
content to plain text where required</p></div></div><div class="code"><div class="wrapper">        <span class="nx">names</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="s2">&quot;pert_type_label&quot;</span><span class="p">){</span>
            <span class="nx">line_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">CMapPertTypeAlias</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="s2">&quot;pert_type&quot;</span><span class="p">]).</span><span class="nx">acronym</span><span class="p">);</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">line_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">n</span><span class="p">]));</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">line_string</span> <span class="o">=</span> <span class="nx">line_data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">);</span>
        <span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line_string</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">lines_string</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">lines_string</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;text/plain;charset=utf-8&quot;</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span> <span class="s2">&quot;CMapTable&quot;</span> <span class="o">+</span> <span class="nx">timestamp</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;_download&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;font color=&quot;#0072B2&quot;&gt;&lt;i class=&quot;icon-share&quot;&gt;&lt;/i&gt; export table&lt;/font&gt;&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="hide">hide</h3>

<p>hides the view by dimming the opacity and hiding it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the hide animation. defualts to <em>500</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.hide(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">hide</span><span class="p">();},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="show">show</h3>

<p>shows the view by brightening the opacity and showing it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the show animation. defualts to <em>500</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.show(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="htmlcellview"><strong>HTMLCellView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a Backgrid extension that supports display of html content in Backgrid tables.  HTMLCellView defines
both a Backgrid.Cell subclass (<strong>HTMLCell</strong>) and Backgrid.CellFormatter subclass (<strong>HTMLFormatter</strong>) to
use with it.  These two components are used together to integrate with Backgrid's existing cell definitions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>in order to use <strong>HTMLCell</strong> and <strong>HTMLFormatter</strong>, specify the cell parameter of a Backgrid column definition
as <strong>HTMLCell</strong>.  As an example:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>// set up a default collection and column definition for the grid to operate on
this.collection = new PertCollection();
this.columns = [{name: "pert_type_label", label: "Pert Type", cell: HTMLCell, editable: false}];

// build the template
this.compile_template();

// build the grid on the template
this.grid = new Backgrid.Grid({
  columns: this.columns,
  collection: this.collection
});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="htmlformatter">HTMLFormatter</h2>

<p>A formatter that extends Backgrid.CellFormatter to return exactly the raw input value as opposed
to the string version of the rawinput </p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">HTMLFormatter</span> <span class="o">=</span> <span class="nx">Backgrid</span><span class="p">.</span><span class="nx">HTMLFormatter</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">HTMLFormatter</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backgrid</span><span class="p">.</span><span class="nx">CellFormatter</span><span class="p">();</span>
<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">HTMLFormatter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">fromRaw</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rawValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">rawValue</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span><span class="nx">rawValue</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rawValue</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="htmlcell">HTMLCell</h2>

<p>An extension of Backgrid.Cell to render raw html content into the target element of the cell</p></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">HTMLCell</span> <span class="o">=</span> <span class="nx">Backgrid</span><span class="p">.</span><span class="nx">HTMLCell</span> <span class="o">=</span> <span class="nx">Backgrid</span><span class="p">.</span><span class="nx">Cell</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">className</span><span class="o">:</span> <span class="s2">&quot;html-cell&quot;</span><span class="p">,</span>
  <span class="nx">formatter</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">HTMLFormatter</span><span class="p">(),</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formatter</span><span class="p">.</span><span class="nx">fromRaw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">column</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))));</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="heatmapview"><strong>HeatmapView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that displays a simple heatmap.  The view is normally paired with 
a <em>HeatmapModel</em>, but works with any model that provides <em>data</em>, <em>rid</em>, <em>cid</em>, and
<em>title</em> attributes.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>template</strong>  The handlebars template to use. Defaults to <em>BaristaTemplates.d3_target</em></li>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>low_color</strong>  the hex color code to use as lowest value color in the heatmap, defaults to <em>#0000ff</em></li>
<li>{string}  <strong>high_color</strong>  the hex color code to use as highest value color in the heatmap, defaults to <em>#ff0000</em></li>
<li>{d3.scale}  <strong>color_scale</strong>  custom color scale to use in the heatmap.  If supplied, low_color and high_color are ignored, defaults to <em>undefined</em></li>
<li>{d3.scale}  <strong>annot<em>color</em>scale</strong>  custom color scale to use in the heatmap annotations. defaults to <em>undefined</em> and causes the annotations to be rendered with a standard color scale</li>
<li>{Number}  <strong>plot_height</strong>  the height of the heatmap to generate in pixels, defaults to <em>300</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>example usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>heatmap_view = new HeatmapView({el: $("target_selector"),
                                        model: new HeatmapModel(),
                                        template: BaristaTemplates.d3_target,
                                        bg_color: "#ffffff",
                                        low_color: "#0000ff",
                                        high_color: "#ff0000",
                                        color_scale: undefined,
                                        annot_color_scale: undefined,
                                        plot_height: 300,
                                        span_class: "span12"
                                        });
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">HeatmapView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;HeatMapView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">HeatmapModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the defualt Backbone.View initialize method to bind the view to model changes, bind
window resize events to view re-draws, compile the template, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">low_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">low_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">low_color</span> <span class="o">:</span> <span class="s2">&quot;#0000ff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">high_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">high_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">high_color</span> <span class="o">:</span> <span class="s2">&quot;#ff0000&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">annot_color_scale</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">annot_color_scale</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">annot_color_scale</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the defualt plot height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="mi">300</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">:</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default span class</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;#span12&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view and draw it for the first time</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the view for the first time</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>completely redraw the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">redraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_panel</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-panel">init_panel</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_panel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check to see if the container is visible, if not, make it visible, but transparent so we draw it with
the proper dimensions</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;:hidden&quot;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the margin</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the height and width of cells in the heatmap</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the plot offset to center the plot in its container</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>map the data into a flattened array of objects with array indices and value as attributes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unravel_data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the color scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
      <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">data_min</span><span class="p">,</span><span class="nx">data_max</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">low_color</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">high_color</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the annotation color scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">annot_color_scale</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots&#39;</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">annot_color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category10</span><span class="p">().</span><span class="nx">domain</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">annot_color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">annot_color_scale</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the heatmap cells</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_cell&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the row labels</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_rid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_rid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rid&#39;</span><span class="p">)).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_rid&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the column labels</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cid&#39;</span><span class="p">)).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_cid&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;middle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the annotation categories if they are present</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_annots&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_annots&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots&#39;</span><span class="p">)).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_annots&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">annot_color</span><span class="p">(</span><span class="nx">d</span><span class="p">);});</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots_label&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the annot label if it is there</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_annots_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_annots_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots_label&#39;</span><span class="p">)]).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_annots_label&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the y scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scale</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axis</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add an axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis y-axis&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,0)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">style_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add the cells for the look up table</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">add_lookup_table</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="add-look-up-table">add look up table</h3>

<p>adds a simple color lookup table based on the heatmap's color_scale</p></div></div><div class="code"><div class="wrapper">  <span class="nx">add_lookup_table</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">scale_range</span><span class="p">,</span> <span class="nx">scale_domain</span><span class="p">,</span> <span class="nx">scale_unit</span><span class="p">,</span> <span class="nx">domain_unit</span><span class="p">;</span>
    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
    <span class="nx">scale_range</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">.</span><span class="nx">range</span><span class="p">();</span>
    <span class="nx">scale_domain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">();</span>
    <span class="nx">scale_unit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">scale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">scale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">domain_unit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">scale_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">scale_domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.lut_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;lut_cell&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">i</span><span class="o">*</span><span class="nx">scale_unit</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="nx">scale_unit</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">scale_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">i</span><span class="o">*</span><span class="nx">domain_unit</span><span class="p">);});</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="set-scale">set_scale</h3>

<p>utility function used to get the y scale used in the plot</p></div></div><div class="code"><div class="wrapper">  <span class="nx">set_scale</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">domain</span><span class="p">,</span> <span class="nx">range_min</span><span class="p">,</span> <span class="nx">range_max</span><span class="p">,</span> <span class="nx">range</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the current data domain from this.color</p></div></div><div class="code"><div class="wrapper">      <span class="nx">domain</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">domain</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>calculate the range for the scale</p></div></div><div class="code"><div class="wrapper">      <span class="nx">range_min</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">;</span>
      <span class="nx">range_max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">;</span>
      <span class="nx">range</span> <span class="o">=</span> <span class="p">[</span><span class="nx">range_min</span><span class="p">,</span><span class="nx">range_max</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the y_scale</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">domain</span><span class="p">[</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="nx">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">(</span><span class="nx">range</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="build-axis">build_axis</h3>

<p>utility function used to build y axis for the look up table</p></div></div><div class="code"><div class="wrapper">  <span class="nx">build_axis</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="style-axes">style axes</h3>

<p>utility function to apply custom styles to axis components</p></div></div><div class="code"><div class="wrapper">  <span class="nx">style_axes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;11px&quot;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the height and width of cells in the heatmap</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the plot offset to center the plot in its container</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>map the data into a flattened array of objects with array indices and value as attributes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unravel_data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the color scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
      <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">data_min</span><span class="p">,</span><span class="nx">data_max</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">low_color</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">high_color</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the annotation color scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">annot_color_scale</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots&#39;</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">annot_color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category10</span><span class="p">().</span><span class="nx">domain</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">annot_color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">annot_color_scale</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the heatmap cells</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">cell_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">);</span>
    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_cell&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_center</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);});</span>

    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);});</span>

    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the row labels</p></div></div><div class="code"><div class="wrapper">    <span class="nx">rid_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_rid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rid&#39;</span><span class="p">));</span>
    <span class="nx">rid_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_rid&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="nx">rid_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="nx">rid_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the column labels</p></div></div><div class="code"><div class="wrapper">    <span class="nx">cid_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cid&#39;</span><span class="p">));</span>
    <span class="nx">cid_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_cid&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_center</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;middle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="nx">cid_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="nx">cid_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the annotation categories if they are present</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">label_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_annots&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots&#39;</span><span class="p">));</span>
      <span class="nx">label_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_annots&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_center</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">annot_color</span><span class="p">(</span><span class="nx">d</span><span class="p">);});</span>

      <span class="nx">label_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">annot_color</span><span class="p">(</span><span class="nx">d</span><span class="p">);});</span>

      <span class="nx">label_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots_label&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the annot label if it is there</p></div></div><div class="code"><div class="wrapper">        <span class="nx">label_text_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_annots_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;annots_label&#39;</span><span class="p">)]);</span>
        <span class="nx">label_text_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_annots_label&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

        <span class="nx">label_text_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
          <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

        <span class="nx">label_text_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="unravel-data">unravel_data</h3>

<p>internal utility function to express 2D array data as a flat data array of objects with array
coordinates and data value as attributes.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">unravel_data</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">unraveled_data</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i_e</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
      <span class="nx">i_e</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">j_e</span><span class="p">,</span><span class="nx">j</span><span class="p">){</span>
        <span class="nx">unraveled_data</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">j</span><span class="p">,</span> <span class="nx">j</span><span class="o">:</span><span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="nx">j_e</span><span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">unraveled_data</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;cmapHeatmapView&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span><span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);});}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="ldmapview"><strong>LDMapView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that displays a simple LDMap.  The view is normally paired with 
a <em>HeatMapModel</em>, but works with any model that provides <em>data</em>,<em>cid</em>, and
<em>title</em> attributes.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>template</strong>  The handlebars template to use. Defaults to <em>BaristaTemplates.d3_target</em></li>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>low_color</strong>  the hex color code to use as lowest value color in the LDMap, defaults to <em>#0000ff</em></li>
<li>{string}  <strong>high_color</strong>  the hex color code to use as highest value color in the LDMap, defaults to <em>#ff0000</em></li>
<li>{d3.scale}  <strong>color_scale</strong>  custom color scale to use in the LDMap.  If supplied, low_color and high_color are ignored, defaults to <em>undefined</em></li>
<li>{Number}  <strong>plot_height</strong>  the height of the LDMap to generate in pixels, defaults to <em>300</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>example usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>LDMap_view = new LDMapView({el: $("target_selector"),
                                        model: new HeatmapModel(),
                                        template: BaristaTemplates.d3_target,
                                        bg_color: "#ffffff",
                                        low_color: "#0000ff",
                                        high_color: "#ff0000",
                                        color_scale: undefined,
                                        plot_height: 300,
                                        span_class: "span12"
                                        });
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">LDMapView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;LDMapView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">HeatmapModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the defualt Backbone.View initialize method to bind the view to model changes, bind
window resize events to view re-draws, compile the template, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">low_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">low_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">low_color</span> <span class="o">:</span> <span class="s2">&quot;#0000ff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">high_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">high_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">high_color</span> <span class="o">:</span> <span class="s2">&quot;#ff0000&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the defualt plot height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="mi">300</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default template</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">:</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default span class</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;#span12&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view and draw it for the first time</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the view for the first time</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>completely redraw the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">redraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_panel</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-panel">init_panel</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_panel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check to see if the container is visible, if not, make it visible, but transparent so we draw it with
the proper dimensions</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;:hidden&quot;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the margin</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.ld_cell_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ld_cell_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;ld_cell_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the height and width of cells in the heatmap</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the plot offset to center the plot in its container</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>map the data into a flattened array of objects with array indices and value as attributes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unravel_data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the color scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
      <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">data_min</span><span class="p">,</span><span class="nx">data_max</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">low_color</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">high_color</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the LDMap cells</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">ld_cell_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ld_cell_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_cell&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;</span>
        <span class="k">return</span> <span class="s1">&#39;rotate(45,&#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the row labels</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_rid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_rid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rid&#39;</span><span class="p">)).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_rid&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">diamond_height</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">diamond_height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;-.2em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the height and width of cells in the heatmap</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">usable_height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">diamond_height</span> <span class="o">=</span> <span class="nx">usable_height</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">diamond_height</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the plot offset to center the plot in its container</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_center</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>map the data into a flattened array of objects with array indices and value as attributes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unravel_data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the color scale</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
      <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">data_min</span><span class="p">,</span><span class="nx">data_max</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">low_color</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">high_color</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color_scale</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the heatmap cells</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">cell_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ld_cell_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_cell&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unraveled_data</span><span class="p">);</span>
    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_cell&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_center</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);});</span>

    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span><span class="o">*</span><span class="nx">d</span><span class="p">.</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cell_height</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;</span>
        <span class="k">return</span> <span class="s1">&#39;rotate(45,&#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);});</span>

    <span class="nx">cell_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the row labels</p></div></div><div class="code"><div class="wrapper">    <span class="nx">rid_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.heatmap_rid&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rid&#39;</span><span class="p">));</span>
    <span class="nx">rid_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;heatmap_rid&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;-.5em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="nx">rid_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">cell_width</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_offset</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">diamond_height</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">diamond_height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">margin</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="nx">rid_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="unravel-data">unravel_data</h3>

<p>internal utility function to express 2D array data as a flat data array of objects with array
coordinates and data value as attributes.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">unravel_data</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">unraveled_data</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i_e</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
      <span class="nx">i_e</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">j_e</span><span class="p">,</span><span class="nx">j</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">){</span>
          <span class="nx">unraveled_data</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span><span class="nx">j</span><span class="p">,</span> <span class="nx">j</span><span class="o">:</span><span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="nx">j_e</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">unraveled_data</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;cmapHeatmapView&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span><span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);});}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertcountview"><strong>PertCountView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that shows that number of perturbagens matching a given query.  Optionally, sub-category
counts are give for the type of perturbagen queried for.  This view is frequently paired with a 
<strong>PertCountModel</strong> or <strong>CellCountModel</strong></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>count_view = new PertCountView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>well_color</strong>  the hex color code to use as the backgound of the wells, defaults to <em>#bdbdbd</em></li>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"col-lg-4"</em></li>
<li>{string}  <strong>static_text</strong>  the static text header to use in the view, defaults to <em>"Reagents"</em></li>
<li>{array}  <strong>categories</strong>  an array of objects to use as categories to display, defaults to <em>[]</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>count_view = new PertCountView({bg_color:"#ffffff", 
                            well_color: "#bdbdbd",
                            fg_color: "#1b9e77",
                            span_class: "span4",
                            static_text: "Reagents",
                            categories: []});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">PertCountView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;PertCountView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertCountModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">well_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">well_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">well_color</span> <span class="o">:</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">:</span> <span class="s2">&quot;#1b9e77&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;col-lg-4&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up static text, default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">static_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">static_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">static_text</span> <span class="o">:</span> <span class="s2">&quot;Reagents&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default plot height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="mi">120</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up default categories to display</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">categories</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">categories</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">categories</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_ids</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get categories from model and determine the maximum category count
this.categories = this.model.get('pert_types');</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">max_category_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>completely redraw the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">redraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_panel</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-panel">init_panel</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_panel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.controls_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;controls_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static Text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.static_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.static_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;static_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;13pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">static_text</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">());</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the pert count info</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">count_text</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.count&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="nx">count_text</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.count&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">55</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;36pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each sub-category, draw a bar graph well</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">category_rect_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_rect_well&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_rect_selection</span><span class="p">.</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_rect_selection</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;category_rect_well&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">i</span><span class="o">*</span><span class="mi">35</span> <span class="o">+</span> <span class="mi">80</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">well_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each sub-category, draw a bar graph</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">category_rect_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_rect&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_rect_selection</span><span class="p">.</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_rect_selection</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;category_rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">i</span><span class="o">*</span><span class="mi">35</span> <span class="o">+</span> <span class="mi">80</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span> <span class="o">/</span> <span class="nx">self</span><span class="p">.</span><span class="nx">max_category_count</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each sub-category, add a name</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_name&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_name&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;category_name&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">i</span><span class="o">*</span><span class="mi">35</span> <span class="o">+</span> <span class="mi">105</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;12pt&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">CMapPertTypeAlias</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">name</span><span class="p">;});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each sub-category, add a value</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_value&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_value&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;category_value&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">i</span><span class="o">*</span><span class="mi">35</span> <span class="o">+</span> <span class="mi">105</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;12pt&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;xhtml:div&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span>
  <span class="p">},</span>

  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the pert count info</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.count&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">count</span><span class="p">);</span>
          <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">numberWithCommas</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">i</span><span class="p">(</span><span class="nx">t</span><span class="p">)))</span> <span class="p">;</span>
          <span class="p">};</span>
      <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition the updated bars</p></div></div><div class="code"><div class="wrapper">    <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pert_types</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pert_types&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pert_types</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pert_types</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">category_ids</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;});</span>
    <span class="kd">var</span> <span class="nx">category_counts</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pert_types</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">category_sum</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">category_counts</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">num</span><span class="p">){</span> <span class="k">return</span> <span class="nx">memo</span> <span class="o">+</span> <span class="nx">num</span><span class="p">;</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pert_types</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="nx">count</span><span class="o">:</span><span class="nx">count</span> <span class="o">-</span> <span class="nx">category_sum</span><span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="nx">l</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pert_types</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">categories</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pert_types</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">count</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">categories</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_category_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">max_category_count</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">max_category_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">max_category_count</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">category_update_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_rect&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">);</span>
    <span class="nx">category_update_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span> <span class="o">/</span> <span class="nx">self</span><span class="p">.</span><span class="nx">max_category_count</span><span class="p">);});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition the updated category labels</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_value&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">count</span><span class="p">);</span>
          <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">numberWithCommas</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">i</span><span class="p">(</span><span class="nx">t</span><span class="p">)));</span>
          <span class="p">};</span>
      <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;BaristaPertCountView&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span>
        <span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="pertdetailview"><strong>PertDetailView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that shows the name and short description of a single purturbagen.  This view is
frequently paired with a PertDetailModel.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view = new PertDetailView({el: $("target_selector")});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view = new PertDetailView({el: $("target_selector"),
                                        model: PertDetailModel,
                                        bg_color: "#ffffff",
                                        span_class: "span4"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">PertDetailView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;PertDetailView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PertDetailModel</span><span class="p">(),</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the defualt Backbone.View initialize method to bind the view to model changes, bind
window resize events to view re-draws, compile the template, and render the view</p></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.initialize();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span class</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;#col-lg-12&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>template_string</strong>  an html string specifying the template to compile and render. defaults to <code>'&lt;div id="' + this.div_string + '" class="' + this.span_class + '" style="height:180px"&gt;&lt;/div&gt;'</code></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.compile_template(template\_string);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template_string</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>perform a full redraw of the view, including wiping out all d3 drawn components in the view and 
initializing them again from scratch.</p></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.redraw();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">redraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_view</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-view">init_view</h3>

<p>set up the view from scratch.  Draw a background panel and place all dynamic content on that panel
with defualt values</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.init_view();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">init_view</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff "this" into a variable for use inside of scoped funcitons</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static index reagent icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;foreignObject&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;index_text_icon&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;xhtml:div&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_index_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;p class=&quot;cmap-subhead-text&quot;&gt;&lt;font color=&quot;#56B4E9&quot;&gt;&lt;i class=&quot;icon-map-marker&quot;&gt;&lt;/i&gt;&lt;/font&gt;&lt;p&gt;&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static index reagent text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.index_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;index_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;14pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;INDEX REAGENT&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>render the dynamic content of the view based on the current state of the view's data model</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.render();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw a link to the gene's wikipedia article if it is a gene.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_link&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.gene_wiki_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check for a link definition for wikipedia.  If there is one, draw a card that
displays a link out to the article and the extract of the article.  If there
is no link provided, just display the short and long name version of the card</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;gene_wiki_link&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;&quot;</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up wikipedia API query parameters</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
              <span class="nx">titles</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;short_description&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_(gene)&quot;</span><span class="p">,</span>
              <span class="nx">prop</span><span class="o">:</span> <span class="s2">&quot;extracts&quot;</span><span class="p">,</span>
              <span class="nx">format</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
              <span class="nx">exchars</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
              <span class="nx">exlimit</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="nx">exintro</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
              <span class="nx">exsectionformat</span><span class="o">:</span> <span class="s2">&quot;wiki&quot;</span><span class="p">,</span>
              <span class="nx">redirects</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
              <span class="nx">explaintext</span><span class="o">:</span> <span class="kc">true</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a query into the wikipedia API to get the article extract.  Once the
extract has come back, draw the short description, long description , 
the wiki link, and article stub</p></div></div><div class="code"><div class="wrapper">      <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;http://en.wikipedia.org/w/api.php?callback=?&#39;</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the short name of the perturbagen</p></div></div><div class="code"><div class="wrapper">        <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.short_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.short_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;short_description_text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;36pt&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;short_description&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the long name of the perturbagen</p></div></div><div class="code"><div class="wrapper">        <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.long_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.long_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;long_description_text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">85</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;14pt&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;long_description&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the wiki link</p></div></div><div class="code"><div class="wrapper">        <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_link&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_link no_png_export&#39;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
                  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
                  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;gene_wiki_link&quot;</span><span class="p">)})</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;wiki&#39;</span><span class="p">);</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>drill into the wikipedia API response and grab the article extract.
break it into 50 character lines to display and draw each of those lines.
If line breaks fall in the middle of a word, place a dash at the end of
the line.  If the extract does not fit on four lines (200 characters),
add an ellipsis to the end of the line.</p></div></div><div class="code"><div class="wrapper">        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">res</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">pages</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">pages</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">p</span><span class="p">)){</span>
            <span class="kd">var</span> <span class="nx">extract</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">pages</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">extract</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">extract</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the line splits to display in the wiki summary</p></div></div><div class="code"><div class="wrapper">              <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">];</span>
              <span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
              <span class="nx">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">49</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
              <span class="nx">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">49</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">);</span>
              <span class="nx">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">extract</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw line 1</p></div></div><div class="code"><div class="wrapper">              <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text1&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text1 gene_wiki_text&#39;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">425</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;13pt&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#777777&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw line 2</p></div></div><div class="code"><div class="wrapper">              <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text2 &#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text2 gene_wiki_text&#39;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">425</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;13pt&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#777777&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw line 3</p></div></div><div class="code"><div class="wrapper">              <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text3&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text3 gene_wiki_text&#39;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">425</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">46</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;13pt&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#777777&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw line 4</p></div></div><div class="code"><div class="wrapper">              <span class="nx">self</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text4&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s1">&#39;gene_wiki_text4 gene_wiki_text&#39;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">425</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;13pt&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#777777&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>

    <span class="p">}</span><span class="k">else</span><span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the short name of the perturbagen</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.short_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.short_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;short_description_text&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;36pt&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;short_description&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the long name of the perturbagen</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.long_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.long_description_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;long_description_text&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">85</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;14pt&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;long_description&#39;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="hide">hide</h3>

<p>hides the view by dimming the opacity and hiding it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the hide animation. defualts to <em>1</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.hide(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">hide</span><span class="p">();},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="show">show</h3>

<p>shows the view by brightening the opacity and showing it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the show animation. defualts to <em>1</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.show(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.save_png();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;cmapPertDetailView&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span><span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);})};</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span>
<span class="cm">/**</span>
<span class="cm">A Backbone.View that exposes a custom search bar.  The search bar provides autocomplete</span>
<span class="cm">functionality for Connectivity Map pert\_inames and cell\_ids.  When the user types in the</span>
<span class="cm">search view&#39;s input, a &quot;search:DidType&quot; event is fired.</span>

<span class="cm">@class PertSearchBar</span>
<span class="cm">@constructor</span>
<span class="cm">@extends Backbone.View</span>
<span class="cm">**/</span>
<span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">PertSearchBar</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;PertSearchBar&quot;</span><span class="p">,</span>

  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">    determines wether or not the search view will match cell lines for autocomplete</span>

<span class="cm">    @property match_cell_lines</span>
<span class="cm">    @default true</span>
<span class="cm">    @type Boolean</span>
<span class="cm">    **/</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up custom Datasets if they are passed in the constructor</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">:</span> <span class="p">[</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">.</span><span class="nx">CellID</span><span class="p">,</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">.</span><span class="nx">PertIName</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine wether or not we will match cell line strings in the autocomplete</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">match_cell_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">match_cell_lines</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">match_cell_lines</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>custom placeholder</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">placeholder</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">placeholder</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">placeholder</span> <span class="o">:</span> <span class="s1">&#39;search gene, compound or cell type name&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab cell_ids and store them as an atribute of the view</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">cellinfo</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/cellinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="s1">&#39;{&quot;cell_id&quot;:{&quot;$regex&quot;:&quot;&quot;}}&#39;</span><span class="p">,</span><span class="nx">d</span><span class="o">:</span><span class="s2">&quot;cell_id&quot;</span><span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">cellinfo</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">cell_lines</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>once the view is rendered, bind a change event to trigger a "search:DidType" event from the view</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">change_callback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span>  <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">cell_lines</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">match_cell_lines</span><span class="p">){</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;cell&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">        Fired when the text in the view&#39;s search box changes</span>

<span class="cm">        @event search:DidType</span>
<span class="cm">        @param {Object} [msg={val:&quot;&quot;,type:&quot;&quot;}] an object containing the message of the event</span>
<span class="cm">        @param {String} [msg.val=&quot;&quot;] the string val of the views search bar at the time of the event</span>
<span class="cm">        @param {String} [msg.type=&quot;&quot;] the type of message being passed, either &quot;&quot; or &quot;cell&quot;. &quot;cell&quot; is passed, if the string matches a cell line and match\_cell\_lines is set</span>
<span class="cm">        **/</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">});</span>
      <span class="p">};</span>

      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;input propertychange change&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span><span class="p">(</span><span class="nx">change_callback</span><span class="p">,</span><span class="mi">500</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind a search:DidType event to the typeahead events coming out of typeahead.js</p></div></div><div class="code"><div class="wrapper">      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.typeahead&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;typeahead:selected typeahead:autocompleted&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">datum</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">type</span><span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>

  <span class="p">},</span>


  <span class="cm">/**</span>
<span class="cm">    Gets the current text entered in the view&#39;s search bar</span>

<span class="cm">    @method get_val</span>
<span class="cm">    **/</span>
  <span class="nx">get_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">    fills the view&#39;s search bar with a random pert_iname and triggers a &quot;search:DidType&quot; event</span>

<span class="cm">    @method random_val</span>
<span class="cm">    **/</span>
  <span class="nx">random_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">skip</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">40000</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pertinfo</span> <span class="o">=</span> <span class="s1">&#39;http://api.lincscloud.org/a2/pertinfo?callback=?&#39;</span><span class="p">;</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">&#39;{&quot;pert_type&quot;:{&quot;$in&quot;:[&quot;trt_cp&quot;,&quot;trt_sh&quot;]}}&#39;</span><span class="p">,</span>
          <span class="nx">f</span><span class="o">:</span><span class="s1">&#39;{&quot;pert_iname&quot;:1}&#39;</span><span class="p">,</span>
                    <span class="nx">l</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nx">sk</span><span class="o">:</span><span class="nx">skip</span><span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">pertinfo</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pert_iname</span><span class="p">;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;single&#39;</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="nx">set_val</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">new_val</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#search&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">new_val</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;search:DidType&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">new_val</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;single&#39;</span><span class="p">});</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">    renders the view</span>

<span class="cm">    @method render</span>
<span class="cm">    **/</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>load the template into the view's el tag</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">CMapPertSearchBar</span><span class="p">({</span><span class="nx">placeholder</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">placeholder</span><span class="p">}));</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#search&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">).</span><span class="nx">typeahead</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">datasets</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="platformsummaryview"><strong>PlatformSummaryView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that shows a quick view card used to display the available data on lincscloud.org
for a given platform. The widget displays a count of the available experiments on the platform, 
a description of the platform, a widget to extract a listing of the data available, and a link 
to a platform specific app for viewing the contents of the available data on that platform. <br />
This view is frequently paired with a <strong>PlatformSummaryModel</strong></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>platform_summary_view = new PlatformSummaryView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>...</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>platform_summary_view = new PlatformSummaryView({ 
                            ... });
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">PlatformSummaryView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;PlatformSummaryView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">GenericCountModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color and font defaults</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">white_color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span> <span class="o">=</span> <span class="s2">&quot;#000000&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">orange_color</span> <span class="o">=</span> <span class="s2">&quot;#e69f00&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sky_blue_color</span> <span class="o">=</span> <span class="s2">&quot;#56b4e9&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bluish_green_color</span> <span class="o">=</span> <span class="s2">&quot;#009e73&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">yellow_color</span> <span class="o">=</span> <span class="s2">&quot;#f0e442&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">blue_color</span> <span class="o">=</span> <span class="s2">&quot;#0072b2&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vermillion_color</span> <span class="o">=</span> <span class="s2">&quot;#d55e00&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reddish_purple_color</span> <span class="o">=</span> <span class="s2">&quot;#cc79a7&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">opaque_opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">semi_opacity</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span> <span class="o">=</span> <span class="s2">&quot;&#39;Helvetica Neue&#39;,Helvetica,Arial,sans-serif&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">brand_font_family</span> <span class="o">=</span> <span class="s2">&quot;&#39;Memphis LT Std&#39;,Times,serif&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">navigation_font_family</span> <span class="o">=</span> <span class="s2">&quot;Tahoma,Verdana,sans-serif&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bold_font_weight</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">medium_font_weight</span> <span class="o">=</span> <span class="s2">&quot;medium&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">regular_font_weight</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lowercase_font_transform</span> <span class="o">=</span> <span class="s2">&quot;lowercase&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uppercase_font_transform</span> <span class="o">=</span> <span class="s2">&quot;uppercase&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sentence_font_transform</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">wide_letter_spacing</span> <span class="o">=</span> <span class="s2">&quot;2pt&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fonts_default</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">brand</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">brand_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bold_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;13pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uppercase_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">wide_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">},</span>
      <span class="nx">control</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">regular_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;12pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">lowercase_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sky_blue_color</span>
      <span class="p">},</span>
      <span class="nx">count</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bold_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;36pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sentence_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">},</span>
      <span class="nx">header</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bold_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;13pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uppercase_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">},</span>
      <span class="nx">navigation</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">navigation_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">regular_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;9pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sentence_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">},</span>
      <span class="nx">paragraph</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">regular_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;12pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sentence_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">},</span>
      <span class="nx">subhead</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">medium_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;14pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sentence_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">},</span>
      <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">family</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text_font_family</span><span class="p">,</span>
        <span class="nx">weight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bold_font_weight</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="s2">&quot;36pt&quot;</span><span class="p">,</span>
        <span class="nx">transform</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sentence_font_transform</span><span class="p">,</span>
        <span class="nx">spacing</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal_letter_spacing</span><span class="p">,</span>
        <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">black_color</span>
      <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color and font appearance options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">white_color</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fg_color</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">orange_color</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fonts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fonts_default</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;col-lg-4&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up static banner text, default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">banner_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">banner_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">banner_text</span> <span class="o">:</span> <span class="s2">&quot;Platform&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up static description text, default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">description_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">description_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">description_text</span> <span class="o">:</span> <span class="s2">&quot;Platform description&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up static experiments text, default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">experiments_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">experiments_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">experiments_text</span> <span class="o">:</span> <span class="s2">&quot;Experiments&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default plot height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="mi">305</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the platform icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">platform_icon</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">platform_icon</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">platform_icon</span> <span class="o">:</span> <span class="s1">&#39;http://coreyflynn.github.io/Bellhop/img/cmap_logo_small.png&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up static export table, default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">export_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">export_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">export_text</span> <span class="o">:</span> <span class="s2">&quot;download table&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">exporting_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">exporting_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">exporting_text</span> <span class="o">:</span> <span class="s2">&quot;Exporting&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up static view details, default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">details_text</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">details_text</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">details_text</span> <span class="o">:</span> <span class="s2">&quot;view details&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">details_url</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">details_url</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">details_url</span> <span class="o">:</span> <span class="s2">&quot;http://apps.lincscloud.org&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">details_target</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">details_target</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">details_target</span> <span class="o">:</span> <span class="s2">&quot;_self&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up default categories to display</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">categories</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">categories</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">categories</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_ids</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get categories from model and determine the maximum category count
this.categories = this.model.get('platform_types');</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">max_category_count</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">categories</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">));</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>completely redraw the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">redraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_panel</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">},</span>
  
  <span class="nx">apply_font</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">font</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span> <span class="nx">font</span><span class="p">.</span><span class="nx">family</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">,</span> <span class="nx">font</span><span class="p">.</span><span class="nx">weight</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="nx">font</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;text-transform: &quot;</span> <span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">transform</span> <span class="o">+</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;letter-spacing&quot;</span><span class="p">,</span> <span class="nx">font</span><span class="p">.</span><span class="nx">spacing</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="nx">font</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
  <span class="p">},</span>
  
  <span class="nx">font_to_css_style</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">font</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;font:&quot;</span><span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">weight</span> <span class="o">+</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">size</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">family</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span>
      <span class="o">+</span> <span class="s2">&quot;color:&quot;</span> <span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span> 
      <span class="o">+</span> <span class="s2">&quot;text-transform:&quot;</span> <span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">transform</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span> 
      <span class="o">+</span> <span class="s2">&quot;letter-spacing:&quot;</span> <span class="o">+</span> <span class="nx">font</span><span class="p">.</span><span class="nx">spacing</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-panel">init_panel</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_panel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up component row positioning</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">hrule0</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hrule1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule0</span> <span class="o">+</span> <span class="mi">30</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule1</span> <span class="o">+</span> <span class="mi">30</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hrule3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span> <span class="o">+</span> <span class="mi">120</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hrule4</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule3</span> <span class="o">+</span> <span class="mi">30</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hrule5</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule4</span> <span class="o">+</span> <span class="mi">25</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.controls_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;controls_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the banner</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.banner&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">banner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;banner&quot;</span><span class="p">);</span>
    <span class="nx">banner</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.banner_rect&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="nx">banner</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;banner_rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span>
    <span class="nx">banner</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.banner_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">bt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">apply_font</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fonts</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">banner</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.banner_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;banner_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">hrule0</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">banner_text</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>center the banner text</p></div></div><div class="code"><div class="wrapper">    <span class="nx">bt</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">text_width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getBBox</span><span class="p">().</span><span class="nx">width</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">start_pos</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">text_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="nx">bt</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nx">start_pos</span><span class="p">);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the description text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render_description</span><span class="p">({</span>
      <span class="nx">description_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">description_text</span><span class="p">,</span>
      <span class="nx">left</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
      <span class="nx">top</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span><span class="p">,</span>
      <span class="nx">bottom</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
      <span class="nx">node_class</span><span class="o">:</span> <span class="s1">&#39;description_text&#39;</span>
    <span class="p">});</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the generic count info</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">count_text</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.count&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="nx">count_text</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">apply_font</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fonts</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.count&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">hrule3</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">count</span><span class="p">));</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the experiments text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.experiments_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">apply_font</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fonts</span><span class="p">.</span><span class="nx">header</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.experiments_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;experiments_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">hrule4</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">experiments_text</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static platform icon</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.platform_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.platform_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:image&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;platform_icon&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">platform_icon</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">hrule5</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">semi_opacity</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">opaque_opacity</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">sky_blue_color</span><span class="p">);})</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">semi_opacity</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">black_color</span><span class="p">);})</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>css inline styling, this value can have single quotes in it, so use double-quotes to apply it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">control_css_style</span> <span class="o">=</span> <span class="s2">&quot;text-decoration:none; &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">font_to_css_style</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fonts</span><span class="p">.</span><span class="nx">control</span><span class="p">);</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine control positioning based on display size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">details_x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">135</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">details_y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule4</span> <span class="o">-</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">// 15 is a hack adjusting for line height</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">export_x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">270</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">export_y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">details_y</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">export_x</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>move the export above the details</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">export_x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">details_x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">export_y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">details_y</span> <span class="o">-</span> <span class="mi">30</span><span class="p">;</span>
    <span class="p">}</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add the export table control</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render_export_control</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">export_text</span><span class="p">,</span> <span class="s2">&quot;icon-download&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">download_table</span><span class="p">();});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add the view details control</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.details_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.details_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;foreignObject&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;details_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">110</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">110</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">details_x</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">details_y</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;xhtml:body&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;a href=&#39;&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">details_url</span><span class="o">+</span><span class="s2">&quot;&#39; target=&#39;&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">details_target</span><span class="o">+</span><span class="s2">&quot;&#39; style=\&quot;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">control_css_style</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&gt;&lt;i class=&#39;icon-chevron-sign-right&#39;&gt;&lt;/i&gt; &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">details_text</span><span class="o">+</span><span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  
  <span class="nx">render_export_control</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">icon_class</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.export_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.export_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;foreignObject&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;export_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">export_x</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">export_y</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="nx">handler</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;xhtml:body&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;span style=\&quot;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">control_css_style</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&gt;&lt;i class=&#39;&quot;</span> <span class="o">+</span> <span class="nx">icon_class</span> <span class="o">+</span> <span class="s2">&quot;&#39; style=&#39;margin-right:2px;&#39;&gt;&lt;/i&gt;&quot;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="download-table">download_table</h3>

<p>download the backing data that matches the current model state.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">download_table</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>indicate that we are downloading something</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render_export_control</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exporting_text</span><span class="p">,</span> <span class="s2">&quot;icon-refresh icon-spin&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up api call parameters</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">&#39;{&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;search_field&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;:{&quot;$regex&quot;:&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;search_string&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;$options&quot;:&quot;i&quot;}}&#39;</span><span class="p">,</span>
            <span class="nx">l</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make a JSON API call to grab data for the table</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the headers for the table we are going to write out</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We are going to write a one line in the table for each object returned by the API
call.  Start by putting the headers in and then write each object to the table</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nx">headers</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">)];</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">line_data</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for each data name in the table, grab the data. translate html
content to plain text where required</p></div></div><div class="code"><div class="wrapper">        <span class="nx">headers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">h</span><span class="p">){</span>
            <span class="nx">line_data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">h</span><span class="p">]));</span>
        <span class="p">});</span>
        <span class="nx">line_string</span> <span class="o">=</span> <span class="nx">line_data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">);</span>
        <span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line_string</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">lines_string</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">lines_string</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;text/plain;charset=utf-8&quot;</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span> <span class="s2">&quot;CMapTable&quot;</span> <span class="o">+</span> <span class="nx">timestamp</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>indicate that we are done</p></div></div><div class="code"><div class="wrapper">      <span class="nx">self</span><span class="p">.</span><span class="nx">render_export_control</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">export_text</span><span class="p">,</span> <span class="s2">&quot;icon-download&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">download_table</span><span class="p">();});</span>
    <span class="p">});</span>
  <span class="p">},</span>
  
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the pert count info</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.count&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">count</span><span class="p">);</span>
          <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">numberWithCommas</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">i</span><span class="p">(</span><span class="nx">t</span><span class="p">)))</span> <span class="p">;</span>
          <span class="p">};</span>
      <span class="p">});</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render-description">render_description</h3>

<p>utility function to break a long description string into a multiline
and draw it at the desired location</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>options</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>description_string</strong>  the string to be displayed, defaults to <em>""</em></li>
<li>{right}  <strong>right</strong>  the x position to place the <strong>right</strong> edge of text, defaults to <em>this.width</em></li>
<li>{left}  <strong>left</strong>  the x position to place the <strong>left</strong> edge of text, defaults to <em>this.width - 500</em></li>
<li>{top}  <strong>top</strong>  the y position to place the <strong>top</strong> edge of text, defaults to <em>0</em></li>
<li>{bottom}  <strong>bottom</strong>  the y position to place the <strong>bottom</strong> edge of text, defaults to <em>100</em></li>
<li>{node<em>class}  <strong>node</em>class</strong>  the class used for locating the text node within fg_layer, defaults to <em>""</em></li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">render_description</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>default arguments if they are not present</p></div></div><div class="code"><div class="wrapper">    <span class="nx">description_string</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">description_string</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">description_string</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">top_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">top</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">top</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">bottom_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">:</span> <span class="mi">100</span><span class="p">;</span>
    <span class="nx">right_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">right</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">right</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">left_edge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">left</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">left</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">500</span><span class="p">;</span>
    <span class="nx">node_class</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">node_class</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">node_class</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">node_class_selector</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">node_class</span><span class="p">;</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>clear existing description</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="nx">node_class_selector</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the number of lines we have room for</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">line_height</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the layout is small we can't have more than 5 lines or descriptions collide with the count</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">num_lines_allowed</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">bottom_edge</span> <span class="o">-</span> <span class="nx">top_edge</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">line_height</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the number of characters per line we will allow and how
many lines the description would need if we rendered all of it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">line_width</span> <span class="o">=</span> <span class="nx">right_edge</span> <span class="o">-</span> <span class="nx">left_edge</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>12 pt font</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">num_char</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">line_width</span> <span class="o">/</span> <span class="mi">12</span> <span class="o">/</span> <span class="p">.</span><span class="mi">65</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">num_lines</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">description_string</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compute the line splits to display in the description</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">num_lines</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">num_lines_allowed</span> <span class="o">-</span> <span class="mi">1</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="p">(</span><span class="nx">description_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">description_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">description_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="nx">description_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">description_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span><span class="p">,(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">num_char</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>note: the class that had the original line-splitting code does not have this break, and that may be a bug</p></div></div><div class="code"><div class="wrapper">        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw lines</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">apply_font</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fonts</span><span class="p">.</span><span class="nx">paragraph</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="nx">node_class_selector</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">node_class</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">left_edge</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">top_edge</span> <span class="o">+</span> <span class="mi">13</span> <span class="o">+</span> <span class="nx">i</span><span class="o">*</span><span class="mi">15</span><span class="p">;})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>.attr("text-anchor", "middle")</p></div></div><div class="code"><div class="wrapper">        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;}));</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>temporarily fix content to work around canvg rendering problems</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.platform_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render_description</span><span class="p">({</span>
      <span class="nx">description_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">description_text</span><span class="p">,</span>
      <span class="nx">left</span><span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
      <span class="nx">top</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span><span class="p">,</span>
      <span class="nx">bottom</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
      <span class="nx">node_class</span><span class="o">:</span> <span class="s1">&#39;description_text&#39;</span>
    <span class="p">});</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>restore content</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.platform_icon&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:image&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;platform_icon&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">platform_icon</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render_description</span><span class="p">({</span>
      <span class="nx">description_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">description_text</span><span class="p">,</span>
      <span class="nx">left</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
      <span class="nx">top</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">hrule2</span><span class="p">,</span>
      <span class="nx">bottom</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
      <span class="nx">node_class</span><span class="o">:</span> <span class="s1">&#39;description_text&#39;</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render to the canvas</p></div></div><div class="code"><div class="wrapper">    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;BaristaPlatformSummaryView&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span>
        <span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="scatterplotview"><strong>ScatterPlotView</strong></h1>

<p>A Backbone.View that displays a scatter plot.  the view's model is assumed to have the same defaults
as specified in <strong>ScatterPlotModel</strong></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>scatter_plot_view = new ScatterPlotView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
<li>{string}  <strong>scale_by</strong>  an attribute in the model's meta data object to scale points by, defaults to <em>undefined</em></li>
<li>{Array}  <strong>x<em>range</strong>  a two element array specifying the x plotting bounds of the plot, defaults to *[min(x</em>data),max(x_data)]*</li>
<li>{Array}  <strong>y<em>range</strong>  a two element array specifying the y plotting bounds of the plot, defaults to *[min(y</em>data),max(y_data)]*</li>
<li>{Bool}  <strong>x_log</strong>  if set to true, plots the x axis on a log scale, defaults to <em>false</em></li>
<li>{Bool}  <strong>y_log</strong>  if set to true, plots the y axis on a log scale, defaults to <em>false</em></li>
<li>{Number} <strong>x<em>min</em>lock</strong> if set, locks the minimum of the x<em>range at the given value. Ignored if x</em>range is set. defaults to <em>undefined</em></li>
<li>{Number} <strong>y<em>min</em>lock</strong> if set, locks the minimum of the y<em>range at the given value. Ignored if y</em>range is set. defaults to <em>undefined</em></li>
<li>{Number} <strong>x<em>max</em>lock</strong> if set, locks the maximum of the x<em>range at the given value. Ignored if x</em>range is set. defaults to <em>undefined</em></li>
<li>{Number} <strong>y<em>max</em>lock</strong> if set, locks the maximum of the y<em>range at the given value. Ignored if y</em>range is set. defaults to <em>undefined</em></li>
<li>{Bool} <strong>x<em>min</em>expand</strong> if set, allows the minimum of the x_range to expand if data is found below it. defaults to <em>false</em></li>
<li>{Bool} <strong>y<em>min</em>expand</strong> if set, allows the minimum of the y_range to expand if data is found below it. defaults to <em>false</em></li>
<li>{Bool} <strong>x<em>max</em>expand</strong> if set, allows the maximum of the x_range to expand if data is found above it. defaults to <em>false</em></li>
<li>{Bool} <strong>y<em>max</em>expand</strong> if set, allows the maximum of the y_range to expand if data is found above it. defaults to <em>false</em></li>
<li>{Number}  <strong>plot_height</strong>  the height of the plot in pixels, defaults to <em>120</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>scatter_plot_view = new ScatterPlotView({el: $("target_selector",
                            bg_color:"#ffffff", 
                            fg_color: "#1b9e77",
                            span_class: "span4",
                            scale_by: undefined,
                            x_range: undefined,
                            y_range: undefined,
                            x_log: false,
                            y_log: false,
                            x_min_lock: undefined,
                            y_min_lock: undefined,
                            x_max_lock: undefined,
                            y_max_lock: undefined,
                            x_min_expand: false,
                            y_min_expand: false,
                            x_max_expand: false,
                            y_max_expand: false,
                            plot_height: 120});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ScatterPlotView</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaBaseView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ScatterPlotModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y range and determine if are going to draw the axes dynamically</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dynamic_x_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dynamic_y_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up axis expansion and lock features</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_min_lock</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_min_lock</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_min_lock</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_min_lock</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_min_lock</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_min_lock</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_max_lock</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_max_lock</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_max_lock</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_max_lock</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_max_lock</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_max_lock</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">x_min_expand</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_min_expand</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_min_expand</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_min_expand</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_min_expand</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_min_expand</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_max_expand</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_max_expand</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_max_expand</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_max_expand</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_max_expand</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_max_expand</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y log flags</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_log</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_log</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_log</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_log</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_log</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_log</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the scale_by parameter</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the margin</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_ranges</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scales</span><span class="p">();</span>    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run BaristaBaseView's base_initialize method to handle boilerplate view construction
and initial view rendering</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_initialize</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>completely redraw the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_plot</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-plot">init_plot</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_plot</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_ranges</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scales</span><span class="p">();</span>    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis x-axis&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xAxis</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis y-axis&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="s2">&quot;,0)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style the axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;11px&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a scaling function</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">set_scaling_function</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the data points</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_point&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_point&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_data</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;data_point&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the x axis title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;x_axis_label axis_label&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_axis_title&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the y axis label</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.y_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.y_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;y_axis_label axis_label&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>.attr("transform", "rotate(-90)")</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span><span class="s2">&quot;1em&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_axis_title&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;title title&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get model data</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">x_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">y_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">);</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">set_ranges</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y scaling</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">set_scales</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build Axes</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">build_axes</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a scaling function</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">set_scaling_function</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the data points, appending where required</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">points_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.data_point&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_data</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">points_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;data_point&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition points</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">points_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">y_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);})</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dot_scaler</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">scale_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove excess points </p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">points_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition the axes</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x-axis&#39;</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xAxis</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.y-axis&#39;</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">style_axes</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="set-ranges">set_ranges</h3>

<p>utility function used to get the x and y ranges used in the plot</p></div></div><div class="code"><div class="wrapper">  <span class="nx">set_ranges</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">x_data</span><span class="p">,</span><span class="nx">y_data</span><span class="p">,</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>calculate the x_range. If we need to caluclate it dynamically, check the lock and expand
parameters for the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dynamic_x_range</span> <span class="o">===</span> <span class="kc">true</span><span class="p">){</span>
      <span class="nx">x_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the data is of length larger than 1, calculate the range, otherwise set the range to [0,0]</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">x_data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check the min lock and expand flags and report the min of the range accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_min_lock</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">x_data</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_min_expand</span><span class="p">){</span>
            <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">x_data</span><span class="p">);</span>
            <span class="nx">min</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_min_lock</span> <span class="o">&gt;</span> <span class="nx">data_min</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data_min</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_min_lock</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">min</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_min_lock</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check the max lock and expand flags and report the max of the range accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_max_lock</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">x_data</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_max_expand</span><span class="p">){</span>
            <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">x_data</span><span class="p">);</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_max_lock</span> <span class="o">&lt;</span> <span class="nx">data_max</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data_max</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_max_lock</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x_max_lock</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">];</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>calculate the y_range. If we need to caluclate it dynamically, check the lock and expand
parameters for the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dynamic_y_range</span> <span class="o">===</span> <span class="kc">true</span><span class="p">){</span>
      <span class="nx">y_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the data is of length larger than 1, calculate the range, otherwise set the range to [0,0]</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">y_data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check the min lock and expand flags and report the min of the range accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_min_lock</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">y_data</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_min_expand</span><span class="p">){</span>
            <span class="nx">data_min</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">y_data</span><span class="p">);</span>
            <span class="nx">min</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_min_lock</span> <span class="o">&gt;</span> <span class="nx">data_min</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data_min</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_min_lock</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">min</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_min_lock</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check the max lock and expand flags and report the max of the range accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_max_lock</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
          <span class="nx">max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">y_data</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_max_expand</span><span class="p">){</span>
            <span class="nx">data_max</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">y_data</span><span class="p">);</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_max_lock</span> <span class="o">&lt;</span> <span class="nx">data_max</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data_max</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_max_lock</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y_max_lock</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">];</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="set-scales">set_scales</h3>

<p>utility function used to get the x and y scales used in the plot</p></div></div><div class="code"><div class="wrapper">  <span class="nx">set_scales</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_log</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_log</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="build-axes">build_axes</h3>

<p>utility function used to build x and y axes</p></div></div><div class="code"><div class="wrapper">  <span class="nx">build_axes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">yAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="set_scaling_function">set<em>scaling</em>function</h3>

<p>utility function to compute a radius scaling funciton to use in plots</p></div></div><div class="code"><div class="wrapper">  <span class="nx">set_scaling_function</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">scale_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;meta_data&#39;</span><span class="p">)[</span><span class="k">this</span><span class="p">.</span><span class="nx">scale_by</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">size_min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scale_data</span><span class="p">)</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">size_max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scale_data</span><span class="p">)</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">size_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">size_min</span><span class="p">,</span><span class="nx">size_max</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dot_scaler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span>
        <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">val</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">size_scale</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="style-axes">style axes</h3>

<p>utility function to apply custom styles to axis components</p></div></div><div class="code"><div class="wrapper">  <span class="nx">style_axes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;11px&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><strong>TagListView</strong>
A Backbone.View that displays a list of objects in a collection as tags.  The tags are drawn
as rounded rectangles with text inside.  The text corresponds to the cid attributes in the
collection by defaul, but can be customized to display other fields if required</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tag_list_view = new TagListView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>white</em></li>
<li>{string}  <strong>tag_color</strong>  the hex color code to use as the tag color of the view, defaults to <em>gray</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"col-lg-12"</em></li>
<li>{Number}  <strong>plot_height</strong>  the height of the plot in pixels, defaults to <em>120</em></li>
<li>{string}  <strong>display_field</strong>  the model attribute to display for each model in the view's colleciton.  defualts to <em>'cid'</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tag_list_view = new TagListView({el: $("target_selector",
                            bg_color:"#ffffff", 
                            fg_color: "white",
                            tag_color: "gray",
                            span_class: "col-lg-12",
                            plot_height: 120,
                            display_attribute: "cid"});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">TagListView</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaBaseView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;TagListView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set of the default model for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="collection">collection</h3>

<p>set up a default collection for the view to work with</p></div></div><div class="code"><div class="wrapper">  <span class="nx">collection</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>initialize the base view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_initialize</span><span class="p">();</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a display attribute </p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">display_attribute</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">display_attribute</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">display_attribute</span> <span class="o">:</span> <span class="s1">&#39;cid&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a tag color to use </p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">tag_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tag_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tag_color</span> <span class="o">:</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>look for custom listeners</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listener</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">listener</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">listener</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>clear built in listeners</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">stopListening</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add listeners for the collection and trigger an update when it changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">listener</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">listener</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>completely render the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>call BaristaBaseView's render function first so we can layer on top of it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a text element for each unique item in the collection</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">row_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_offsets</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lengths</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">display_attribute</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">draw_tags</span><span class="p">();</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>call BaristaBaseView's render function first so we can layer on top of it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a text element for each unique item in the collection</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">row_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_offsets</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lengths</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">display_attribute</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tags</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">draw_tags</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="fit-height">fit_height</h3>

<p>fits the view height to the height taken by the tags displayed</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fit_height</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the view's height attribute based on the number of rows in the
vis</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">EmSize</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">getEmSizeInPixels</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">row_number</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="mf">3.5</span><span class="p">)</span> <span class="o">*</span> <span class="nx">EmSize</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the height of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">height</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
    
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="draw-tags">draw tags</h3>

<p>utility function to draw tags diven a data set.  </p></div></div><div class="code"><div class="wrapper">  <span class="nx">draw_tags</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the foreground text of all the tags</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tag_list_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tag_list_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;tag_list_text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">lengths</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getComputedTextLength</span><span class="p">()</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">current_x_offset</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">current_x_offset</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">lengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">width</span><span class="p">){</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">lengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">row_number</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">lengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">y_offsets</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">self</span><span class="p">.</span><span class="nx">row_number</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;em&#39;</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;TagListView:DidSelect&quot;</span><span class="p">,{</span><span class="nx">val</span><span class="o">:</span> <span class="nx">d</span><span class="p">});});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of all the tags</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tag_list_rect&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tag_list_rect&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tags</span><span class="p">).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;tag_list_rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">y_offsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;em&#39;</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;ry&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">lengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;})</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="s1">&#39;1.2em&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">tag_color</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fit_height</span><span class="p">();</span>

    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="tickview"><strong>TickView</strong></h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A Backbone.View that displays a Connectivity Map tick view.  The view is must be paired with a CMapTickModel that
describes the rows to display in the tick view and the scores of the ticks to show for each row.  An 
example input data object from a CMapTickModel might looks like this:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    {PC3: [.23,-.28], MCF7: [-0.6]}
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The view will render a row for each key in the data object and a tick for each entry in the array values
for each row.  The view also renders a title based on the model's title attribute</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>template</strong>  The path to a handlebars template to use. Defaults to <em>../templates/d3_target.handlebars</em></li>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#bdbdbd</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>example usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tick_view = new TickView({el: $("target_selector"),
                                        model: new CMapTickModel({data:{PC3: [.23,-.28], MCF7: [-0.6]}, title: "example data"}),
                                        template: "../templates/d3_target.handlebars",
                                        bg_color: "#bdbdbd",
                                        span_class: "span12"
                                        });
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">TickView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="name">name</h3>

<p>give the view a name to be used throughout the View's functions when it needs to know what its class name is</p></div></div><div class="code"><div class="wrapper">  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;TickView&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">TickModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the defualt Backbone.View initialize method to bind the view to model changes, bind
window resize events to view re-draws, compile the template, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up color options.  default if not specified</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">bg_color</span> <span class="o">:</span> <span class="s2">&quot;#eeeeee&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;#span12&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">:</span> <span class="s2">&quot;../templates/d3_target.handlebars&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view and draw it for the first time</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template_and_draw</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to redraw</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile_template_and_draw">compile<em>template</em>and_draw</h3>

<p>use Handlebars to compile the template for the view and draw it for the first time</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tick_view.compile_template_and_draw();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template_and_draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isCompiling</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">}));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">isCompiling</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the plot for the first time</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redraw">redraw</h3>

<p>perform a full redraw of the view, including wiping out all d3 drawn components in the view and 
initializing them again from scratch.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tick_view.redraw();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">redraw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height via animation</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">height</span><span class="o">:</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data_object&#39;</span><span class="p">)).</span><span class="nx">length</span><span class="o">*</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">50</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>once the height is determined, render the view</p></div></div><div class="code"><div class="wrapper">    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">init_view</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="p">},</span><span class="mi">501</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-view">init_view</h3>

<p>set up the view from scratch.  Draw a background panel and place all dynamic content on that panel
with defualt values</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tick_view.init_view();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">init_view</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff "this" into a variable for use inside of scoped funcitons</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>check to see if the container is visible, if not, make it visible, but transparent so we draw it with
the proper dimensions</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;:hidden&quot;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the height of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up scaling and margin parameters for the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">well_offset</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">well_offset</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build an xAxis</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">xAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the x axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">xAxis</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style the axis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;11px&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab data from the model and sort it according to the values in the object</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">data_array</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pairs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data_object&#39;</span><span class="p">));</span>
    <span class="nx">data_array</span> <span class="o">=</span> <span class="nx">data_array</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">data_array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">category</span><span class="p">){</span>
      <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">category</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">category</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static index reagent text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;title_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;14pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static category wells</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_well&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_well&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;category_well&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">well_offset</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="mi">18</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">23</span><span class="p">;})</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">well_offset</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                  <span class="k">return</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">;</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                  <span class="k">return</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the ticks</p></div></div><div class="code"><div class="wrapper">    <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value_array</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
      <span class="nx">tick_class</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;tick&#39;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">tick_class</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">tick_class</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">value_array</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;tick &quot;</span> <span class="o">+</span> <span class="nx">tick_class</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">18</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">23</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="s2">&quot;#ff0000&quot;</span><span class="p">);</span>
    <span class="p">});</span>

    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a png export overlay</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">+</span> <span class="s2">&quot;png_export no_png_export&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#56B4E9&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.25</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">);})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">save_png</span><span class="p">();});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>render the dynamic content of the view based on the current state of the view's data model</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tick_view.render();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab data from the model and sort it according to the values in the object</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">data_array</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pairs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data_object&#39;</span><span class="p">));</span>
    <span class="nx">data_array</span> <span class="o">=</span> <span class="nx">data_array</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">arrayAverage</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">data_array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">category</span><span class="p">){</span>
      <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">category</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">category</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the static category text</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_text_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.category_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">keys</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">category_text_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;category_text&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="mi">18</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">;})</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;Helvetica Neue&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;14pt&quot;</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">;});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">category_text_selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="hide">hide</h3>

<p>hides the view by dimming the opacity and hiding it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the hide animation. defualts to <em>1</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.hide(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">check_interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="nx">check_for_compiled_template</span><span class="p">(),</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">check_for_compiled_template</span><span class="p">(){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">isCompiling</span><span class="p">){</span>
        <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">check_interval</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">hide</span><span class="p">();},</span><span class="nx">duration</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="show">show</h3>

<p>shows the view by brightening the opacity and showing it in the DOM</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>arguments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{number}  <strong>duration</strong>  the time in ms for the show animation. defualts to <em>1</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>pert_detail_view.show(duration);
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">){</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="savepng">savePng</h3>

<p>save the current state of the view into a png image</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>tick_view.save_png();
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">save_png</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build a canvas element to store the image temporarily while we save it</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">html_snippet</span> <span class="o">=</span> <span class="s1">&#39;&lt;canvas id=&quot;tmpCanvas&quot; width=&quot;&#39;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">html_snippet</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dim the png label on the image</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">png_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.no_png_export&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">png_opacity</span> <span class="o">=</span> <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">);</span>
    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab the content of the target svg and place it in the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">svg_snippet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">canvg</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tmpCanvas&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;svg&gt;&#39;</span> <span class="o">+</span> <span class="nx">svg_snippet</span> <span class="o">+</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreMouse</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">ignoreAnimation</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save the contents of the canvas to file and remove the canvas element</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tmpCanvas&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;cmapTickView&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">){</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBlob</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">blob</span><span class="p">){</span><span class="nx">saveAs</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span><span class="nx">filename</span><span class="p">);})};</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#tmpCanvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make the png label on the image visible again</p></div></div><div class="code"><div class="wrapper">    <span class="nx">png_selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="nx">png_opacity</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="violinplotview"><strong>ViolinPlotView</strong></h1>

<p>A Backbone.View that displays a single scatter plot.  the view's model is assumed to have the same defaults
as specified in <strong>ScatterPlotModel</strong></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic use:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>violin_plot_view = new ViolinPlotView();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optional arguments:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>{string}  <strong>bg_color</strong>  the hex color code to use as the backgound of the view, defaults to <em>#ffffff</em></li>
<li>{string}  <strong>fg_color</strong>  the hex color code to use as the foreground color of the view, defaults to <em>#1b9e77</em></li>
<li>{string}  <strong>span_class</strong>  a bootstrap span class to size the width of the view, defaults to <em>"span12"</em></li>
<li>{Array}  <strong>x<em>range</strong>  a two element array specifying the x plotting bounds of the plot, defaults to *[min(x</em>data),max(x_data)]*</li>
<li>{Array}  <strong>y<em>range</strong>  a two element array specifying the y plotting bounds of the plot, defaults to *[min(y</em>data),max(y_data)]*</li>
<li>{Bool}  <strong>x_log</strong>  if set to true, plots the x axis on a log scale, defaults to <em>false</em></li>
<li>{Bool}  <strong>y_log</strong>  if set to true, plots the y axis on a log scale, defaults to <em>false</em></li>
<li>{Number}  <strong>plot_height</strong>  the height of the plot in pixels, defaults to <em>120</em></li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>violin_plot_view = new ViolinPlotView({el: $("target_selector",
                            bg_color:"#ffffff", 
                            fg_color: "#1b9e77",
                            span_class: "span4",
                            scale_by: undefined,
                            x_range: undefined,
                            y_range: undefined,
                            x_log: false,
                            y_log: false,
                            plot_height: 120});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ViolinPlotView</span> <span class="o">=</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">BaristaBaseView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="model">model</h3>

<p>set up the view's default model</p></div></div><div class="code"><div class="wrapper">  <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ScatterPlotModel</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="initialize">initialize</h3>

<p>overide the default Backbone.View initialize method to handle optional arguments, compile the view
template, bind model changes to view updates, and render the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y range</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y log flags</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_log</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_log</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">x_log</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_log</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_log</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">y_log</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the scale_by parameter</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale_by</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>run BaristaBaseView's base_initialize method to handle boilerplate view construction
and initial view rendering</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">base_initialize</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the default height for the plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot_height</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the span size</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">span_class</span> <span class="o">:</span> <span class="s2">&quot;span12&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind render to model changes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>compile the default template for the view</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">compile_template</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define the location where d3 will build its plot</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>render the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind window resize events to render</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">();}</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="compile-template">compile_template</h3>

<p>use Handlebars to compile the template for the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">compile_template</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span> <span class="o">=</span> <span class="s1">&#39;d3_target&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">BaristaTemplates</span><span class="p">.</span><span class="nx">d3_target</span><span class="p">({</span><span class="nx">div_string</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">,</span>
                        <span class="nx">span_class</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">span_class</span><span class="p">,</span>
                        <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot_height</span><span class="p">}));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="render">render</h3>

<p>completely render the view. Updates both static and dynamic content in the view.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">base_render</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init_plot</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="init-plot">init_plot</h3>

<p>initialize the static parts of the view's panel</p></div></div><div class="code"><div class="wrapper">  <span class="nx">init_plot</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stuff this into a variable for later use</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the margin</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up x and y ranges</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">)),</span><span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">))];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">)),</span><span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">))];</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up scaling</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_log</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_log</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">range</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">]);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up drawing layers</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bg_layer&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.fg_layer&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fg_layer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;fg_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up the panel's width and height</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_string</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rescale the width of the vis</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>draw the background of the panel</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.bg_panel&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg_panel&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">bg_color</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build an Axes</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">xAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">yAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">orient</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">xAxis</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style the axes</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;shape-rendering&quot;</span><span class="p">,</span> <span class="s2">&quot;crispEdges&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.axis&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">,</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span><span class="s2">&quot;11px&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>define an area generator for use in plotting data</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">upper_area_generator</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">area</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">y0</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">y1</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="s1">&#39;basis&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lower_area_generator</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">area</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">x_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">y0</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">y1</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_scale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="s1">&#39;basis&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab data from the model and package it such that we can iterate over it
and generate an area. The packaged data will be sorted by the x_data attribute</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path_data</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span> <span class="nx">self</span><span class="p">.</span><span class="nx">path_data</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]});});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path_data</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path_data_sorter</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the data</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.upper_violin&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.upper_violin&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;upper_violin&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">upper_area_generator</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path_data</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.lower_violin&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.lower_violin&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;lower_violin&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">fg_color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">lower_area_generator</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path_data</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the x axis title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.x_axis_label&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;x_axis_label axis_label&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_axis_title&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plot the title</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.title&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]).</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;title title&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">margin</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span><span class="s2">&quot;middle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">));</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update">update</h3>

<p>update the dynamic potions of the view</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>grab data from the model and package it such that we can iterate over it
and generate an area. The packaged data will be sorted by the x_data attribute</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">x_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x_data&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y_data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;y_data&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path_data</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x_data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span> <span class="nx">self</span><span class="p">.</span><span class="nx">path_data</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">y_data</span><span class="p">[</span><span class="nx">i</span><span class="p">]});});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path_data</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path_data_sorter</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transition the data</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">upper</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.upper_violin&#39;</span><span class="p">);</span>
    <span class="nx">upper</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">upper_area_generator</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path_data</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">lower</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bg_layer</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.lower_violin&#39;</span><span class="p">);</span>
    <span class="nx">lower</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">lower_area_generator</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path_data</span><span class="p">));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="path-data-sorter">path data sorter</h3>

<p>internal method used to sort path_data list elements by the x attribute</p></div></div><div class="code"><div class="wrapper">  <span class="nx">path_data_sorter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">){</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm">Tile constructor</span>
<span class="cm">@param {object} [options={}] options object to set properties</span>
<span class="cm">@classdesc A Tile that displays simple information and serves as a front door to the an underlying app.  The </span>
<span class="cm">tile is composted of a square div element that can be small, medium, or wide.  The height of the tile is 150px</span>
<span class="cm">for small and 300px for large tiles.  The width is expressed as bootstrap span units of 3(small), 6(medium), or</span>
<span class="cm">12(wide).  This base class provides mechanisms for injecting html into the DOM and showing or hiding the tile as</span>
<span class="cm">well as default styling</span>
<span class="cm">@class Tile</span>
<span class="cm">@constructor</span>
<span class="cm">@param {string}  [options.div_target] the div id into which to inject html, defaults to &quot;body&quot;</span>
<span class="cm">@param {string}  [options.div_id] the div id for generated html, defaults to &quot;Tile&quot; plus a random number</span>
<span class="cm">@param {string}  [options.style]  inline style specification, defaults to &quot;#bdbdbd&quot;</span>
<span class="cm">@param {string}  [options.color]  the background color of the tile, defuaults to </span>
<span class="cm">@param {string}  [options.tile_type]  tile type, can be &quot;small&quot;, &quot;medium&quot;, or &quot;wide&quot;, defaults to &quot;medium&quot;</span>
<span class="cm">@param {bool}  [options.display]  true to render the tile on object creation, false not to, defaults to true</span>

<span class="cm">**/</span>
<span class="kd">function</span> <span class="nx">Tile</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span> <span class="o">:</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">div_target</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">div_target</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">div_target</span> <span class="o">:</span> <span class="s2">&quot;body&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">:</span> <span class="s2">&quot;Tile&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">1000000000</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">link</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">link</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">style</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">style</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">color</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">color</span> <span class="o">:</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">:</span> <span class="s2">&quot;medium&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">display</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">display</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>initialize the tile</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">init_state</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">Initializes Tile by building the appropriate html and injecting it into the DOM</span>
<span class="cm">@memberof Tile</span>
<span class="cm">@method init </span>
<span class="cm">**/</span>
<span class="nx">Tile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build the html to inject into the DOM</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">build_html</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>inject the html into the target div</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">inject</span><span class="p">();</span>

  <span class="c1">//draw the background of the tile</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the initialization flag to true</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">init_state</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bind the tile to redraw when the window resizes</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();}</span> <span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">Builds the html for the tile based on the tile_type given in the constructor</span>
<span class="cm">@memberof Tile</span>
<span class="cm">@method build_html </span>
<span class="cm">**/</span>
<span class="nx">Tile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">build_html</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s1">&#39;&quot; class=&quot;span3&quot; style=&quot;height:150px &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s1">&#39;&quot; class=&quot;span6&quot; style=&quot;height:300px &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;wide&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s1">&#39;&quot; class=&quot;span12&quot; style=&quot;height:300px &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">Injects the Tile&#39;s html into the DOM at the target id given in the constructor</span>
<span class="cm">@memberof Tile</span>
<span class="cm">@method inject</span>
<span class="cm">**/</span>
<span class="nx">Tile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">div_target</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">html</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">draws the tiles background using d3.js</span>
<span class="cm">@memberof Tile</span>
<span class="cm">@method draw_bg </span>
<span class="cm">**/</span>
<span class="nx">Tile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_bg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the correct height and width to draw</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a top level svg selection if the tile needs to be initialized</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">init_state</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a group to drawing elements</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;draw_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add a group to link elements</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;link_layer&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add the link</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">link_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.link_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect.link_rect&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">link_selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;ry&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;link_rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the background</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect.bg&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;rect.bg&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;ry&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;bg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">hides the tile</span>
<span class="cm">@param {object} [duration=0] the duration of a fade out animation applied before hiding the tile</span>
<span class="cm">@memberof Tile</span>
<span class="cm">@method hide </span>
<span class="cm">**/</span>
<span class="nx">Tile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="nx">width</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="nx">height</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">hide</span><span class="p">();},</span><span class="nx">duration</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">shows the tile</span>
<span class="cm">@param {object} [duration=0] the duration of a fade out animation applied after showing the tile</span>
<span class="cm">@memberof Tile</span>
<span class="cm">@method show </span>
<span class="cm">**/</span>
<span class="nx">Tile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">width</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">height</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">},</span><span class="nx">duration</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">ImageTile constructor</span>
<span class="cm">@param {object} [options={}] options object to set properties</span>
<span class="cm">@classdesc A Tile that extends the base Tile to add an image in the center of the tile</span>
<span class="cm">@class ImageTile</span>
<span class="cm">@constructor</span>
<span class="cm">@extends Tile</span>
<span class="cm">@param {string}  [options.image] the url to use as the image,defaults to &quot;../Bellhop/img.two_circles.png&quot;</span>
<span class="cm">@param {string}  [options.div_target] the div id into which to inject html, defaults to &quot;body&quot;</span>
<span class="cm">@param {string}  [options.div_id] the div id for generated html, defaults to &quot;Tile&quot; plus a random number</span>
<span class="cm">@param {string}  [options.style] inline style specification, defaults to &quot;#f0f0f0&quot;</span>
<span class="cm">@param {string}  [options.color] the background color of the tile, defuaults to </span>
<span class="cm">@param {string}  [options.tile_type] tile type, can be &quot;small&quot;, &quot;medium&quot;, or &quot;wide&quot;, defaults to &quot;medium&quot;</span>

<span class="cm">**/</span>
<span class="kd">function</span> <span class="nx">ImageTile</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">image</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">image</span> <span class="o">:</span> <span class="s2">&quot;../Bellhop/img/CMap_Logo_gray.png&quot;</span><span class="p">;</span>
  <span class="nx">Tile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">draw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">ImageTile</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tile</span><span class="p">({</span><span class="nx">display</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="nx">ImageTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">ImageTile</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">top level draw wrapper around draw\_bg and draw\_image</span>
<span class="cm">@memberof ImageTile</span>
<span class="cm">@method draw </span>
<span class="cm">**/</span>
<span class="nx">ImageTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_image</span><span class="p">();</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">draws the tile&#39;s image using d3.js</span>
<span class="cm">@memberof ImageTile</span>
<span class="cm">@method draw_image </span>
<span class="cm">**/</span>
<span class="nx">ImageTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_image</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the correct height and width to draw</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a top level svg selection if the tile needs to be initialized</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">init_state</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the image</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">image_size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;image.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">image_selection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;image.&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">image_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">image_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">image_size</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">image_size</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">AnimatedImageTextTile constructor</span>
<span class="cm">@param {object} [options={}] options object to set properties</span>
<span class="cm">@classdesc A Tile that extends the base Tile to add an image in the center of the tile</span>
<span class="cm">@class AnimatedImageTile</span>
<span class="cm">@constructor</span>
<span class="cm">@extends Tile</span>
<span class="cm">@param {string}  [options.image] the url to use as the image,defaults to &quot;../Bellhop/img.two_circles.png&quot;</span>
<span class="cm">@param {string}  [options.div_target] the div id into which to inject html, defaults to &quot;body&quot;</span>
<span class="cm">@param {string}  [options.div_id] the div id for generated html, defaults to &quot;Tile&quot; plus a random number</span>
<span class="cm">@param {string}  [options.style] inline style specification, defaults to &quot;#f0f0f0&quot;</span>
<span class="cm">@param {string}  [options.color] the background color of the tile, defuaults to </span>
<span class="cm">@param {string}  [options.tile_type] tile type, can be &quot;small&quot;, &quot;medium&quot;, or &quot;wide&quot;, defaults to &quot;medium&quot;</span>

<span class="cm">**/</span>
<span class="kd">function</span> <span class="nx">AnimatedImageTile</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">image</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">image</span> <span class="o">:</span> <span class="s2">&quot;../Bellhop/img/CMap_Logo_gray.png&quot;</span><span class="p">;</span>
  <span class="nx">Tile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">draw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">start_animation</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">AnimatedImageTile</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImageTile</span><span class="p">({</span><span class="nx">display</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="nx">AnimatedImageTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">AnimatedImageTile</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">top level draw wrapper around draw\_bg and draw\_image</span>
<span class="cm">@memberof AnimatedImageTile</span>
<span class="cm">@method draw </span>
<span class="cm">**/</span>
<span class="nx">AnimatedImageTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_image</span><span class="p">();</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">starts periodic animation of the Image on the Tile</span>
<span class="cm">@memberof AnimatedImageTile</span>
<span class="cm">@method start_animation </span>
<span class="cm">@param {int}  [duration=2000] duration the length of the animation in milliseconds</span>
<span class="cm">@param {int}  [frequency= 10000 to 20000] frequency the frequency of the animation in milliseconds</span>
<span class="cm">**/</span>
<span class="nx">AnimatedImageTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start_animation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">,</span><span class="nx">frequency</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">duration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">duration</span> <span class="o">:</span> <span class="mi">2000</span><span class="p">;</span>
  <span class="nx">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="nx">frequency</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">frequency</span> <span class="o">:</span> <span class="mi">10000</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">image_selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="o">-</span><span class="nx">self</span><span class="p">.</span><span class="nx">image_size</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">image_size</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">image_size</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">},</span><span class="nx">frequency</span><span class="p">);</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm">ImageTextTile constructor</span>
<span class="cm">@param {object} [options={}] options object to set properties</span>
<span class="cm">@classdesc A Tile that extends ImageTile to add text </span>
<span class="cm">@class ImageTextTile</span>
<span class="cm">@constructor</span>
<span class="cm">@extends ImageTile</span>
<span class="cm">@param {string}  [options.image] the url to use as the image,defaults to &quot;../Bellhop/img.two_circles.png&quot;</span>
<span class="cm">@param {string}  [options.div_target] the div id into which to inject html, defaults to &quot;body&quot;</span>
<span class="cm">@param {string}  [options.div_id] the div id for generated html, defaults to &quot;Tile&quot; plus a random number</span>
<span class="cm">@param {string}  [options.text] the text to display on the panel, defaults to &quot;Title&quot;</span>
<span class="cm">@param {string}  [options.style] inline style specification, defaults to &quot;#f0f0f0&quot;</span>
<span class="cm">@param {string}  [options.color] the background color of the tile, defuaults to </span>
<span class="cm">@param {string}  [options.tile_type] tile type, can be &quot;small&quot;, &quot;medium&quot;, or &quot;wide&quot;, defaults to &quot;medium&quot;</span>

<span class="cm">**/</span>
<span class="kd">function</span> <span class="nx">ImageTextTile</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">&quot;Title&quot;</span><span class="p">;</span>
  <span class="nx">ImageTile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">draw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">ImageTextTile</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImageTile</span><span class="p">({</span><span class="nx">display</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="nx">ImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">ImageTextTile</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">top level draw wrapper around draw\_bg and draw\_image and draw\_text</span>
<span class="cm">@memberof ImageTextTile</span>
<span class="cm">@method draw </span>
<span class="cm">**/</span>
<span class="nx">ImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_image</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_text</span><span class="p">();</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">draws the tile&#39;s text using d3.js</span>
<span class="cm">@memberof ImageTextTile</span>
<span class="cm">@method draw_text </span>
<span class="cm">**/</span>
<span class="nx">ImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the correct height and width to draw</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a top level svg selection if the tile needs to be initialized</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">init_state</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the text</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;wide&quot;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">height</span><span class="p">,</span><span class="nx">width</span><span class="p">,</span><span class="nx">html</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;wide&quot;</span><span class="p">){</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">10</span><span class="o">*</span><span class="mi">5</span><span class="p">;</span>
      <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
      <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">20</span><span class="p">;</span>
      <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h2&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">){</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">10</span><span class="o">*</span><span class="mf">8.5</span><span class="p">;</span>
      <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">10</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
      <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
      <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;h3&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h3&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tile_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tile_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;foreignObject&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;tile_text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;xhtml:div&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">AnimatedImageTextTile constructor</span>
<span class="cm">@param {object} [options={}] options object to set properties</span>
<span class="cm">@classdesc A Tile that extends ImageTile to add text that animates on mouseover</span>
<span class="cm">@class AnimatedImageTextTile</span>
<span class="cm">@constructor</span>
<span class="cm">@extends ImageTile</span>
<span class="cm">@param {string}  [options.image] the url to use as the image,defaults to &quot;../Bellhop/img.two_circles.png&quot;</span>
<span class="cm">@param {string}  [options.div_target] the div id into which to inject html, defaults to &quot;body&quot;</span>
<span class="cm">@param {string}  [options.div_id] the div id for generated html, defaults to &quot;Tile&quot; plus a random number</span>
<span class="cm">@param {string}  [options.text] the text to display on the panel, defaults to &quot;Title&quot;</span>
<span class="cm">@param {string}  [options.style] inline style specification, defaults to &quot;#f0f0f0&quot;</span>
<span class="cm">@param {string}  [options.color] the background color of the tile, defuaults to </span>
<span class="cm">@param {string}  [options.tile_type] tile type, can be &quot;small&quot;, &quot;medium&quot;, or &quot;wide&quot;, defaults to &quot;medium&quot;</span>

<span class="cm">**/</span>
<span class="kd">function</span> <span class="nx">AnimatedImageTextTile</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">&quot;Title&quot;</span><span class="p">;</span>
  <span class="nx">ImageTile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">draw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimatingIn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimatingOut</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">AnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImageTile</span><span class="p">({</span><span class="nx">display</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="nx">AnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">AnimatedImageTextTile</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">top level draw wrapper around draw\_bg and draw\_image and draw\_text</span>
<span class="cm">@memberof AnimatedImageTextTile</span>
<span class="cm">@method draw </span>
<span class="cm">**/</span>
<span class="nx">AnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_image</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_text</span><span class="p">();</span>
  <span class="c1">//add callbacks to expose the display of the animated text</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">link_selection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">show_text</span><span class="p">();});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">link_selection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">hide_text</span><span class="p">();});</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">show the text in the Tile</span>
<span class="cm">@memberof AnimatedImageTextTile</span>
<span class="cm">@method show_text</span>
<span class="cm">**/</span>
<span class="nx">AnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimating</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_text&quot;</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimating</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">TextIsAnimatingIn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;},</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">hide the text in the Tile</span>
<span class="cm">@memberof AnimatedImageTextTile</span>
<span class="cm">@method hide_text </span>
<span class="cm">**/</span>
<span class="nx">AnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimating</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_text&quot;</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimating</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">TextIsAnimatingOut</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;},</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">draws the tile&#39;s text using d3.js</span>
<span class="cm">@memberof AnimatedImageTextTile</span>
<span class="cm">@method draw_text </span>
<span class="cm">**/</span>
<span class="nx">AnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the correct height and width to draw</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a top level svg selection if the tile needs to be initialized</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">init_state</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the text</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">height</span><span class="p">,</span><span class="nx">width</span><span class="p">,</span><span class="nx">html</span><span class="p">;</span>
  <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
  <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
  <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;wide&quot;</span><span class="p">){</span>
    <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h2&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;h3&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h3&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tile_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tile_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;foreignObject&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;tile_text&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="nx">height</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;xhtml:div&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_text&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">FullAnimatedImageTextTile constructor</span>
<span class="cm">@param {object} [options={}] options object to set properties</span>
<span class="cm">@classdesc A Tile that extends AnimatedImageTile to add text that animates on mouseover</span>
<span class="cm">@class FullAnimatedImageTextTile</span>
<span class="cm">@constructor</span>
<span class="cm">@extends ImageTile</span>
<span class="cm">@param {string}  [options.image] the url to use as the image,defaults to &quot;../Bellhop/img.two_circles.png&quot;</span>
<span class="cm">@param {string}  [options.div_target] the div id into which to inject html, defaults to &quot;body&quot;</span>
<span class="cm">@param {string}  [options.div_id] the div id for generated html, defaults to &quot;Tile&quot; plus a random number</span>
<span class="cm">@param {string}  [options.text] the text to display on the panel, defaults to &quot;Title&quot;</span>
<span class="cm">@param {string}  [options.style] inline style specification, defaults to &quot;#f0f0f0&quot;</span>
<span class="cm">@param {string}  [options.color] the background color of the tile, defuaults to </span>
<span class="cm">@param {string}  [options.tile_type] tile type, can be &quot;small&quot;, &quot;medium&quot;, or &quot;wide&quot;, defaults to &quot;medium&quot;</span>

<span class="cm">**/</span>
<span class="kd">function</span> <span class="nx">FullAnimatedImageTextTile</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">&quot;Title&quot;</span><span class="p">;</span>
  <span class="nx">ImageTile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">draw</span><span class="p">();}</span> <span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">start_animation</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimatingIn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimatingOut</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">FullAnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AnimatedImageTile</span><span class="p">({</span><span class="nx">display</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="nx">FullAnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">FullAnimatedImageTextTile</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">top level draw wrapper around draw\_bg and draw\_image and draw\_text</span>
<span class="cm">@memberof FullAnimatedImageTextTile</span>
<span class="cm">@method draw </span>
<span class="cm">**/</span>
<span class="nx">FullAnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_bg</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_image</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">draw_text</span><span class="p">();</span>
  <span class="c1">//add callbacks to expose the display of the animated text</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">link_selection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">show_text</span><span class="p">();});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">link_selection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">hide_text</span><span class="p">();});</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">show the text in the Tile</span>
<span class="cm">@memberof FullAnimatedImageTextTile</span>
<span class="cm">@method show_text</span>
<span class="cm">**/</span>
<span class="nx">FullAnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimatingIn</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_text&quot;</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimating</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">TextIsAnimatingIn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;},</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">hide the text in the Tile</span>
<span class="cm">@memberof FullAnimatedImageTextTile</span>
<span class="cm">@method hide_text </span>
<span class="cm">**/</span>
<span class="nx">FullAnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimatingOut</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_text&quot;</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span><span class="nx">opacity</span><span class="o">:</span><span class="mi">0</span><span class="p">},</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">TextIsAnimating</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">TextIsAnimatingOut</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;},</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">draws the tile&#39;s text using d3.js</span>
<span class="cm">@memberof FullAnimatedImageTextTile</span>
<span class="cm">@method draw_text </span>
<span class="cm">**/</span>
<span class="nx">FullAnimatedImageTextTile</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the correct height and width to draw</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set up a top level svg selection if the tile needs to be initialized</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">init_state</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="o">=</span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">div_id</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_svg&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(re)draw the text</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">height</span><span class="p">,</span><span class="nx">width</span><span class="p">,</span><span class="nx">html</span><span class="p">;</span>
  <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
  <span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
  <span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;wide&quot;</span><span class="p">){</span>
    <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h2&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">tile_type</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">){</span>
    <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;h3&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h3&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tile_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([]).</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.draw_layer&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.tile_text&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;foreignObject&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="s2">&quot;tile_text&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="nx">height</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;xhtml:body&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">div_id</span> <span class="o">+</span> <span class="s2">&quot;_tile_text&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="nx">height</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>

<span class="p">};</span>


<span class="c1">//wrap all of our afterword code so we keep the global namespace clean.  All &#39;global&#39; variables</span>
<span class="c1">//will be exposed in the Barista object</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(){</span>

    <span class="c1">//set the user_key from a local file called barista_config if it is present</span>
    <span class="nx">Barista</span><span class="p">.</span><span class="nx">setUserKey</span><span class="p">(</span><span class="s1">&#39;barista_config.json&#39;</span><span class="p">);</span>

    <span class="c1">//find all of the barista_target div elements on the page</span>
    <span class="kd">var</span> <span class="nx">all_divs</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">barista_targets</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">all_divs</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data_attrs</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data_attrs</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;baristaView&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">barista_targets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">//for each barista target element, instantiate the view and attempt to call the</span>
    <span class="c1">//fetch method of its model. For some views this will not work, but many will. </span>
    <span class="c1">//The idea is that we want to populate the views with data when we can on page load</span>
    <span class="c1">//since the user is not instantiating the view via javascript.  For each target</span>
    <span class="c1">//Element we will also try to bind it to any views that it asks to be bound to. The </span>
    <span class="c1">//binding is assumed to be a binding between the any events coming out of the source view.</span>
    <span class="c1">//the event&#39;s &#39;val&#39; attribute is fed to the view&#39;s model.fetch method</span>
    <span class="nx">barista_targets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">){</span>
        <span class="c1">//grab the view type and make sure it has a unique view name</span>
        <span class="kd">var</span> <span class="nx">view_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">view_type</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">data</span><span class="p">().</span><span class="nx">baristaView</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">view_name</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)){</span>
            <span class="nx">view_name</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">view_name</span> <span class="o">=</span> <span class="nx">view_type</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">view_name</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">view_num</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">view_name</span> <span class="o">=</span> <span class="nx">view_type</span> <span class="o">+</span> <span class="nx">view_num</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>instantiate the view and register it to the generatedViews object in 
   Barista</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">view_params</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="nx">target</span><span class="p">},</span><span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">data</span><span class="p">());</span>
        <span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span><span class="p">[</span><span class="nx">view_name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">.</span><span class="nx">Views</span><span class="p">[</span><span class="nx">view_type</span><span class="p">](</span><span class="nx">view_params</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>try to call the view's fetch method and ignore errors that come up since
   we expect them for views that don't have models supporting a fetch 
   operation</p></div></div><div class="code"><div class="wrapper">        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span><span class="p">[</span><span class="nx">view_name</span><span class="p">].</span><span class="nx">model</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>try to bind views that are specified</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">data</span><span class="p">()).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;bind&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">bind_target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">data</span><span class="p">().</span><span class="nx">bind</span><span class="p">;</span>
            <span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span><span class="p">[</span><span class="nx">view_name</span><span class="p">].</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span><span class="p">[</span><span class="nx">bind_target</span><span class="p">],</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">event_name</span><span class="p">,</span> <span class="nx">e</span><span class="p">){</span>
                <span class="nx">Barista</span><span class="p">.</span><span class="nx">generatedViews</span><span class="p">[</span><span class="nx">view_name</span><span class="p">].</span><span class="nx">model</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}());</span></div></div></div></div></body></html>